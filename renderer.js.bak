const { ipcRenderer } = require('electron');

// ç”ŸæˆUUIDçš„å‡½æ•°
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// è·å–DOMå…ƒç´ 
const notesList = document.getElementById('notes-list');
const notesListContainer = document.getElementById('notes-list-container');
const noteContentContainer = document.getElementById('note-content-container');
const noteEditor = document.getElementById('note-editor');
const noteTitleDisplay = document.getElementById('note-title-display');
const addNoteBtn = document.getElementById('add-note-btn');
const backBtn = document.getElementById('back-btn');
const addNoteDialog = document.getElementById('add-note-dialog');
const addDialogTitle = document.getElementById('add-dialog-title');
const noteTitleInput = document.getElementById('note-title-input');
const cancelBtn = document.getElementById('cancel-btn');
const confirmBtn = document.getElementById('confirm-btn');
const settingsBtn = document.getElementById('settings-btn');
const settingsDialog = document.getElementById('settings-dialog');
const settingsCloseBtn = document.getElementById('settings-close-btn');
const lightThemeBtn = document.getElementById('light-theme-btn');
const darkThemeBtn = document.getElementById('dark-theme-btn');
const foldTitlesToggle = document.getElementById('fold-titles-toggle');
const opacitySlider = document.getElementById('opacity-slider');
const opacityValue = document.getElementById('opacity-value');

// æ–°å¢æ ‡é¢˜å±‚çº§å’Œå­çº§æ•°é‡é™åˆ¶ç›¸å…³å…ƒç´ 
const maxLevelSlider = document.getElementById('max-level-slider');
const maxLevelValue = document.getElementById('max-level-value');
const maxChildrenSlider = document.getElementById('max-children-slider');
const maxChildrenValue = document.getElementById('max-children-value');
const unlimitedChildrenBtn = document.getElementById('unlimited-children-btn');

// æ ‡é¢˜æ æ§åˆ¶æŒ‰é’®
const minimizeBtn = document.getElementById('minimize-btn');
const maximizeBtn = document.getElementById('maximize-btn');
const closeBtn = document.getElementById('close-btn');

// ç¡®è®¤å¯¹è¯æ¡†å…ƒç´ 
const confirmDialog = document.getElementById('confirm-dialog');
const confirmMessage = document.getElementById('confirm-message');
const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
const confirmOkBtn = document.getElementById('confirm-ok-btn');

// å¯Œæ–‡æœ¬å·¥å…·æ 
const formatButtons = document.querySelectorAll('.format-btn');
const fontSizeSelect = document.querySelector('.font-size');
const textColorInput = document.getElementById('text-color');

// æ”¾å¤§æ¨¡å¼
const expandBtn = document.getElementById('expand-btn');
const expandedContainer = document.getElementById('expanded-container');
const expandedContent = document.getElementById('expanded-content');
const collapseBtn = document.getElementById('collapse-btn');

// èƒŒæ™¯è®¾ç½®ç›¸å…³å…ƒç´ 
const backgroundTypeRadios = document.querySelectorAll('input[name="background-type"]');
const backgroundColorContainer = document.getElementById('background-color-container');
const backgroundImageContainer = document.getElementById('background-image-container');
const backgroundUrlContainer = document.getElementById('background-url-container');
const backgroundColorInput = document.getElementById('background-color');
const chooseBackgroundImageButton = document.getElementById('choose-background-image');
const selectedImageName = document.getElementById('selected-image-name');
const backgroundUrlInput = document.getElementById('background-url');

// å¤‡ä»½ç›¸å…³å…ƒç´ 
const backupNotesBtn = document.getElementById('backup-notes-btn');
const backupNotesDialog = document.getElementById('backup-notes-dialog');
const backupNotesList = document.getElementById('backup-notes-list');
const backupCancelBtn = document.getElementById('backup-cancel-btn');
const backupConfirmBtn = document.getElementById('backup-confirm-btn');
const backupPathDialog = document.getElementById('backup-path-dialog');
const backupPathInput = document.getElementById('backup-path-input');
const chooseBackupPathBtn = document.getElementById('choose-backup-path-btn');
const autoSyncToggle = document.getElementById('auto-sync-toggle');
const backupPathCancelBtn = document.getElementById('backup-path-cancel-btn');
const backupPathConfirmBtn = document.getElementById('backup-path-confirm-btn');

// æ·»åŠ è¡¨æƒ…åŒ…æç¤ºç›¸å…³å…ƒç´ 
const emojiTipsToggle = document.getElementById('emoji-tips-toggle');

// æ·»åŠ èµåŠ©æŒ‰é’®
const sponsorBtn = document.getElementById('sponsor-btn');

// æ·»åŠ é“¾æ¥ç®¡ç†ç›¸å…³å…ƒç´ 
const linksBtn = document.getElementById('links-btn');
const linksDialog = document.getElementById('links-dialog');
const linksCloseBtn = document.getElementById('links-close-btn');
const linksList = document.getElementById('links-list');
const addLinkBtn = document.getElementById('add-link-btn');
const editLinkDialog = document.getElementById('edit-link-dialog');
const editLinkTitle = document.getElementById('edit-link-title');
const linkNameInput = document.getElementById('link-name-input');
const linkUrlInput = document.getElementById('link-url-input');
const iconPreview = document.getElementById('icon-preview');
const chooseEmojiBtn = document.getElementById('choose-emoji-btn');
const chooseIconImageBtn = document.getElementById('choose-icon-image-btn');
const emojiPicker = document.getElementById('emoji-picker');
const editLinkCancelBtn = document.getElementById('edit-link-cancel-btn');
const editLinkConfirmBtn = document.getElementById('edit-link-confirm-btn');
const linksDisplay = document.getElementById('links-display');

// æ·»åŠ æŒ‰é’®ä½ç½®ç›¸å…³å…ƒç´ 
const buttonContainer = document.querySelector('.button-container');
const positionLeftRadio = document.getElementById('position-left');
const positionCenterRadio = document.getElementById('position-center');
const positionRightRadio = document.getElementById('position-right');

// æ·»åŠ èƒŒæ™¯é€æ˜åº¦å’Œæ¨¡ç³Šåº¦ç›¸å…³å…ƒç´ 
const backgroundAdjustments = document.getElementById('background-adjustments');
const bgOpacitySlider = document.getElementById('bg-opacity-slider');
const bgOpacityValue = document.getElementById('bg-opacity-value');
const bgBlurSlider = document.getElementById('bg-blur-slider');
const bgBlurValue = document.getElementById('bg-blur-value');
const bgZindexSlider = document.getElementById('bg-zindex-slider');
const bgZindexValue = document.getElementById('bg-zindex-value');

// å½“å‰çŠ¶æ€
let currentNoteId = null;
let currentNoteType = null;
let selectedOutlineId = null;
let selectedNoteLevel = 1; // æ·»åŠ é€‰ä¸­ç¬”è®°å±‚çº§å˜é‡
let selectedNoteType = null; // æ·»åŠ é€‰ä¸­ç¬”è®°ç±»å‹å˜é‡
let isAddingSubnote = false;
let settings = {
  theme: 'light',
  foldTitles: false,
  opacity: 100,
  maxLevel: 5, // æ·»åŠ æœ€å¤§å±‚çº§é™åˆ¶ï¼Œé»˜è®¤5çº§
  maxChildren: 0, // æ·»åŠ æœ€å¤§å­çº§æ•°é‡é™åˆ¶ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶
  background: {
    type: 'none',
    value: '',
    opacity: 100,
    blur: 0,
    zIndex: -1 // æ·»åŠ æ˜¾ç¤ºå±‚çº§é»˜è®¤å€¼
  },
  backups: [],
  emojiTips: false, // æ·»åŠ è¡¨æƒ…åŒ…æç¤ºè®¾ç½®
  links: [], // æ·»åŠ é“¾æ¥æ•°ç»„
  buttonPosition: 'left', // æ·»åŠ æŒ‰é’®ä½ç½®è®¾ç½®
  linksDisplayPosition: 'default' // æ·»åŠ é“¾æ¥æ˜¾ç¤ºä½ç½®è®¾ç½®
};

// é€‰ä¸­çš„ç¬”è®°IDï¼ˆç”¨äºå¤‡ä»½ï¼‰
let selectedBackupNotes = [];

// é“¾æ¥ç®¡ç†ç›¸å…³å˜é‡
let currentEditingLinkId = null;
let selectedIconType = 'emoji';
let selectedIconValue = 'ğŸ”—';

// åˆ†äº«ç›¸å…³å…ƒç´ 
const shareBtn = document.getElementById('share-btn');
const shareDialog = document.getElementById('share-dialog');
const shareOptions = document.querySelectorAll('.share-option');
const shareCancelBtn = document.getElementById('share-cancel-btn');

// æ·»åŠ é‚®ä»¶åˆ†äº«å¯¹è¯æ¡†å…ƒç´ 
const emailShareDialog = document.getElementById('email-share-dialog');
const fromEmailInput = document.getElementById('from-email-input');
const toEmailInput = document.getElementById('to-email-input');
const emailSubjectInput = document.getElementById('email-subject-input');
const emailCancelBtn = document.getElementById('email-cancel-btn');
const emailSendBtn = document.getElementById('email-send-btn');

// æ·»åŠ åº”ç”¨é€‰æ‹©å¯¹è¯æ¡†å…ƒç´ 
const appSelectDialog = document.getElementById('app-select-dialog');
const socialAppsContainer = document.getElementById('social-apps');
const otherAppsContainer = document.getElementById('other-apps');
const browseAppBtn = document.getElementById('browse-app-btn');
const appSelectCancelBtn = document.getElementById('app-select-cancel-btn');

// æ·»åŠ æ ‡é¢˜é¢œè‰²å’Œç½‘ç«™é“¾æ¥å¯¹è¯æ¡†å…ƒç´ 
const titleColorBtn = document.getElementById('title-color-btn');
const titleColorDialog = document.getElementById('title-color-dialog');
const titleColorOptions = document.querySelectorAll('.title-color-option');  // ä¿®æ”¹é€‰æ‹©å™¨
const bgColorOptions = document.querySelectorAll('.bg-color-option');  // æ·»åŠ èƒŒæ™¯é¢œè‰²é€‰æ‹©å™¨
const customTitleColor = document.getElementById('custom-title-color');
const customBgColor = document.getElementById('custom-bg-color');  // æ·»åŠ è‡ªå®šä¹‰èƒŒæ™¯é¢œè‰²è¾“å…¥
const titleColorCancelBtn = document.getElementById('title-color-cancel-btn');
const titleColorConfirmBtn = document.getElementById('title-color-confirm-btn');

const webLinkDialog = document.getElementById('web-link-dialog');
const webLinkTitle = document.getElementById('web-link-title');
const webLinkInput = document.getElementById('web-link-input');
const rememberLinkToggle = document.getElementById('remember-link-toggle');
const webLinkCancelBtn = document.getElementById('web-link-cancel-btn');
const webLinkConfirmBtn = document.getElementById('web-link-confirm-btn');

// å½“å‰é€‰ä¸­çš„é¢œè‰²å’Œåº”ç”¨
let selectedTitleColor = '';
let selectedAppForLink = null;
let selectedBgColor = '';  // æ·»åŠ èƒŒæ™¯é¢œè‰²å˜é‡

// åˆå§‹åŒ–åº”ç”¨
async function initApp() {
  console.log('åˆå§‹åŒ–åº”ç”¨...');
  
  // åˆ›å»ºèƒŒæ™¯å®¹å™¨ï¼ˆæœ€ä¼˜å…ˆï¼‰
  createBackgroundContainer();
  
  // åŠ è½½è®¾ç½®
  await loadSettings();
  // åŠ è½½ç¬”è®°
  await loadNotes();
  
  // äº‹ä»¶ç›‘å¬
  addNoteBtn.addEventListener('click', handleAddButtonClick);
  backBtn.addEventListener('click', showNotesList);
  cancelBtn.addEventListener('click', hideAddNoteDialog);
  confirmBtn.addEventListener('click', handleConfirmAdd);
  
  // åˆ†äº«åŠŸèƒ½ç›¸å…³äº‹ä»¶
  shareBtn.addEventListener('click', showShareDialog);
  shareCancelBtn.addEventListener('click', hideShareDialog);
  shareOptions.forEach(option => {
    option.addEventListener('click', handleShareOption);
  });
  
  // æ·»åŠ ç¬”è®°æ‹–æ‹½å¯¼å‡ºåŠŸèƒ½
  setupNoteDragExport();
  
  // é“¾æ¥ç®¡ç†ç›¸å…³äº‹ä»¶
  linksBtn.addEventListener('click', showLinksDialog);
  linksCloseBtn.addEventListener('click', hideLinksDialog);
  addLinkBtn.addEventListener('click', showAddLinkDialog);
  editLinkCancelBtn.addEventListener('click', hideEditLinkDialog);
  editLinkConfirmBtn.addEventListener('click', saveLink);
  chooseEmojiBtn.addEventListener('click', toggleEmojiPicker);
  chooseIconImageBtn.addEventListener('click', chooseIconImage);
  
  // åˆå§‹åŒ–é“¾æ¥æ˜¾ç¤ºåŒº
  if (settings.links && settings.links.length > 0) {
    // é¦–å…ˆåº”ç”¨ä½ç½®è®¾ç½®
    applyLinksDisplayPosition(settings.linksDisplayPosition || 'default');
    // ç„¶åæ¸²æŸ“é“¾æ¥
    renderLinksDisplay();
    linksDisplay.classList.remove('hidden');
  }
  
  // è®¾ç½®ç›¸å…³äº‹ä»¶
  settingsBtn.addEventListener('click', showSettingsDialog);
  settingsCloseBtn.addEventListener('click', hideSettingsDialog);
  lightThemeBtn.addEventListener('click', () => changeTheme('light'));
  darkThemeBtn.addEventListener('click', () => changeTheme('dark'));
  foldTitlesToggle.addEventListener('change', toggleFoldTitles);
  
  // æ ‡é¢˜å±‚çº§å’Œå­çº§æ•°é‡é™åˆ¶ç›¸å…³äº‹ä»¶
  if (maxLevelSlider) {
    maxLevelSlider.addEventListener('input', updateMaxLevelPreview);
    maxLevelSlider.addEventListener('change', changeMaxLevel);
  }
  
  if (maxChildrenSlider) {
    maxChildrenSlider.addEventListener('input', updateMaxChildrenPreview);
    maxChildrenSlider.addEventListener('change', changeMaxChildren);
  }
  
  // æŒ‰é’®ä½ç½®ç›¸å…³äº‹ä»¶
  if (positionLeftRadio) {
    positionLeftRadio.addEventListener('change', () => {
      if (positionLeftRadio.checked) {
        toggleButtonPosition('left');
      }
    });
  }
  
  if (positionCenterRadio) {
    positionCenterRadio.addEventListener('change', () => {
      if (positionCenterRadio.checked) {
        toggleButtonPosition('center');
      }
    });
  }
  
  if (positionRightRadio) {
    positionRightRadio.addEventListener('change', () => {
      if (positionRightRadio.checked) {
        toggleButtonPosition('right');
      }
    });
  }
  
  // é“¾æ¥æ˜¾ç¤ºä½ç½®ç›¸å…³äº‹ä»¶
  if (linksPositionDefaultRadio) {
    linksPositionDefaultRadio.addEventListener('change', () => {
      if (linksPositionDefaultRadio.checked) {
        toggleLinksDisplayPosition('default');
      }
    });
  }
  
  if (linksPositionRightRadio) {
    linksPositionRightRadio.addEventListener('change', () => {
      if (linksPositionRightRadio.checked) {
        toggleLinksDisplayPosition('right');
      }
    });
  }
  
  if (linksPositionBottomRadio) {
    linksPositionBottomRadio.addEventListener('change', () => {
      if (linksPositionBottomRadio.checked) {
        toggleLinksDisplayPosition('bottom');
      }
    });
  }
  
  // å³ä¾§é“¾æ¥è§¦å‘å™¨ç‚¹å‡»äº‹ä»¶
  if (linksRightTrigger) {
    linksRightTrigger.addEventListener('click', function() {
      linksDisplay.classList.add('active');
      // 5ç§’åè‡ªåŠ¨ç§»é™¤activeçŠ¶æ€
      setTimeout(() => {
        linksDisplay.classList.remove('active');
      }, 5000);
    });
  }
  
  // èµåŠ©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  if (sponsorBtn) {
    sponsorBtn.addEventListener('click', () => {
      // ä½¿ç”¨Electronçš„shellæ¨¡å—æ‰“å¼€å¤–éƒ¨é“¾æ¥
      ipcRenderer.invoke('open-external-link', 'https://afdian.com/a/xieshuoxing');
    });
  }
  
  // è¡¨æƒ…åŒ…æç¤ºç›¸å…³äº‹ä»¶
  if (emojiTipsToggle) {
    emojiTipsToggle.addEventListener('change', toggleEmojiTips);
  }
  
  // å¤‡ä»½ç›¸å…³äº‹ä»¶
  backupNotesBtn.addEventListener('click', showBackupNotesDialog);
  backupCancelBtn.addEventListener('click', hideBackupNotesDialog);
  backupConfirmBtn.addEventListener('click', showBackupPathDialog);
  chooseBackupPathBtn.addEventListener('click', chooseBackupPath);
  backupPathInput.addEventListener('click', chooseBackupPath);
  backupPathCancelBtn.addEventListener('click', hideBackupPathDialog);
  backupPathConfirmBtn.addEventListener('click', executeBackup);
  
  // é€æ˜åº¦è°ƒèŠ‚
  opacitySlider.addEventListener('input', updateOpacityPreview);
  opacitySlider.addEventListener('change', changeOpacity);
  
  // æ ‡é¢˜æ æ§åˆ¶
  minimizeBtn.addEventListener('click', () => {
    ipcRenderer.invoke('window-control', 'minimize');
  });
  
  maximizeBtn.addEventListener('click', () => {
    ipcRenderer.invoke('window-control', 'maximize');
  });
  
  closeBtn.addEventListener('click', () => {
    ipcRenderer.invoke('window-control', 'close');
  });
  
  // ç¡®è®¤å¯¹è¯æ¡†
  confirmCancelBtn.addEventListener('click', hideConfirmDialog);
  
  // å¯Œæ–‡æœ¬å·¥å…·æ 
  formatButtons.forEach(button => {
    button.addEventListener('click', () => {
      const command = button.dataset.command;
      document.execCommand(command, false, null);
      updateToolbarState();
      noteEditor.focus();
    });
  });
  
  fontSizeSelect.addEventListener('change', () => {
    document.execCommand('fontSize', false, fontSizeSelect.value);
    noteEditor.focus();
  });
  
  textColorInput.addEventListener('input', () => {
    document.execCommand('foreColor', false, textColorInput.value);
    noteEditor.focus();
  });
  
  // æ”¾å¤§æ¨¡å¼
  expandBtn.addEventListener('click', expandEditor);
  collapseBtn.addEventListener('click', collapseEditor);
  
  // é€‰æ‹©æ–‡æœ¬æ—¶æ›´æ–°å·¥å…·æ çŠ¶æ€
  noteEditor.addEventListener('mouseup', updateToolbarState);
  noteEditor.addEventListener('keyup', updateToolbarState);
  
  // ç¼–è¾‘å™¨å†…å®¹å˜æ›´æ—¶ä¿å­˜
  noteEditor.addEventListener('input', debounce(saveNoteContent, 500));
  expandedContent.addEventListener('input', debounce(saveExpandedContent, 500));
  
  // æ”¯æŒå›¾ç‰‡æ‹–æ‹½
  noteEditor.addEventListener('dragover', handleDragOver);
  noteEditor.addEventListener('drop', handleDrop);
  expandedContent.addEventListener('dragover', handleDragOver);
  expandedContent.addEventListener('drop', handleDrop);
  
  // é”®ç›˜å¿«æ·é”®
  noteTitleInput.addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
      handleConfirmAdd();
    } else if (event.key === 'Escape') {
      hideAddNoteDialog();
    }
  });
  
  // èƒŒæ™¯è®¾ç½®ç›¸å…³äº‹ä»¶
  backgroundTypeRadios.forEach(radio => {
    radio.addEventListener('change', toggleBackgroundOptions);
  });
  
  backgroundColorInput.addEventListener('change', updateBackgroundColor);
  chooseBackgroundImageButton.addEventListener('click', chooseBackgroundImage);
  backgroundUrlInput.addEventListener('input', debounce(updateBackgroundUrl, 500));
  
  // æ·»åŠ èƒŒæ™¯é€æ˜åº¦å’Œæ¨¡ç³Šåº¦æ§åˆ¶
  bgOpacitySlider.addEventListener('input', updateBgOpacityPreview);
  bgOpacitySlider.addEventListener('change', updateBackgroundSettings);
  bgBlurSlider.addEventListener('input', updateBgBlurPreview);
  bgBlurSlider.addEventListener('change', updateBackgroundSettings);
  bgZindexSlider.addEventListener('input', updateBgZindexPreview);
  bgZindexSlider.addEventListener('change', updateBackgroundSettings);
  
  // å¦‚æœå¯ç”¨äº†è¡¨æƒ…åŒ…æç¤ºï¼Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
  if (settings.emojiTips) {
    document.body.addEventListener('click', showRandomEmoji);
  }
  
  // é‚®ä»¶åˆ†äº«ç›¸å…³äº‹ä»¶
  emailCancelBtn.addEventListener('click', hideEmailShareDialog);
  emailSendBtn.addEventListener('click', sendEmailShare);
  
  // åº”ç”¨é€‰æ‹©å¯¹è¯æ¡†ç›¸å…³äº‹ä»¶
  appSelectCancelBtn.addEventListener('click', hideAppSelectDialog);
  browseAppBtn.addEventListener('click', openSystemAppPicker);
  
  // æ ‡é¢˜é¢œè‰²å’Œç½‘ç«™é“¾æ¥ç›¸å…³äº‹ä»¶
  titleColorBtn.addEventListener('click', showTitleColorDialog);
  titleColorCancelBtn.addEventListener('click', hideTitleColorDialog);
  titleColorConfirmBtn.addEventListener('click', applyTitleColor);
  
  titleColorOptions.forEach(option => {
    option.onclick = () => {
      titleColorOptions.forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      selectedTitleColor = option.dataset.color;
      customTitleColor.value = selectedTitleColor;
    };
  });
  
  bgColorOptions.forEach(option => {
    option.onclick = () => {
      bgColorOptions.forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
      selectedBgColor = option.dataset.color;
      customBgColor.value = selectedBgColor;
    };
  });
  
  // è‡ªå®šä¹‰é¢œè‰²è¾“å…¥äº‹ä»¶
  customTitleColor.oninput = () => {
    selectedTitleColor = customTitleColor.value;
    titleColorOptions.forEach(option => {
      option.classList.remove('selected');
      if (option.dataset.color.toLowerCase() === selectedTitleColor.toLowerCase()) {
        option.classList.add('selected');
      }
    });
  };
  
  customBgColor.oninput = () => {
    selectedBgColor = customBgColor.value;
    bgColorOptions.forEach(option => {
      option.classList.remove('selected');
      if (option.dataset.color.toLowerCase() === selectedBgColor.toLowerCase()) {
        option.classList.add('selected');
      }
    });
  };
  
  webLinkCancelBtn.addEventListener('click', hideWebLinkDialog);
  webLinkConfirmBtn.addEventListener('click', confirmWebLink);
  
  // åœ¨initAppå‡½æ•°ä¸­æ·»åŠ æ— é™åˆ¶æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
  if (unlimitedChildrenBtn) {
    unlimitedChildrenBtn.addEventListener('click', setUnlimitedChildren);
  }
}

// ç®€åŒ–ç‰ˆçš„æ‹–æ‹½åŠŸèƒ½
function setupNoteDragExport() {
  // ä¸ºç¬”è®°åˆ—è¡¨é¡¹æ·»åŠ æ‹–æ‹½èƒ½åŠ›
  notesList.addEventListener('mousedown', function(event) {
    // ç¡®ä¿ç‚¹å‡»çš„æ˜¯ç¬”è®°é¡¹è€Œä¸æ˜¯åˆ é™¤æŒ‰é’®
    const noteItem = event.target.closest('.note-item');
    if (!noteItem || event.target.classList.contains('delete-btn')) return;
    
    const noteId = noteItem.dataset.id;
    if (!noteId) return;
    
    // è®¾ç½®ä¸ºå¯æ‹–æ‹½
    noteItem.setAttribute('draggable', 'true');
    
    // é¼ æ ‡æŠ¬èµ·æ—¶ç§»é™¤draggableå±æ€§
    const mouseUpHandler = function() {
      noteItem.removeAttribute('draggable');
      document.removeEventListener('mouseup', mouseUpHandler);
    };
    
    document.addEventListener('mouseup', mouseUpHandler);
  });

  // å¤„ç†æ‹–æ‹½å¼€å§‹äº‹ä»¶
  notesList.addEventListener('dragstart', async function(event) {
    const noteItem = event.target.closest('.note-item');
    if (!noteItem) return;
    
    const noteId = noteItem.dataset.id;
    if (!noteId) return;
    
    // æ·»åŠ æ‹–æ‹½è§†è§‰åé¦ˆ
    noteItem.classList.add('dragging');
    
    try {
      // è·å–ç¬”è®°å†…å®¹
      const note = await ipcRenderer.invoke('get-note', noteId);
      if (!note) return;
      
      // å‡†å¤‡æ–‡æœ¬å†…å®¹
      let textContent = `${note.title}\n\n`;
      
      // ä»HTMLå†…å®¹ä¸­æå–çº¯æ–‡æœ¬
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = note.content;
      textContent += tempDiv.textContent || tempDiv.innerText || '';
      
      // è®¾ç½®åŸºç¡€æ–‡æœ¬æ•°æ®
      event.dataTransfer.setData('text/plain', textContent);
      event.dataTransfer.effectAllowed = 'copy';
      
      // åˆ›å»ºä¸€ä¸ªçœŸæ­£å”¯ä¸€çš„IDï¼ŒåŒ…å«ç¬”è®°IDç¡®ä¿ä¸åŒç¬”è®°ä¸ä¼šæ··æ·†
      const uniqueId = `${noteId}_${Date.now()}`;
      
      // é€šçŸ¥ä¸»è¿›ç¨‹åˆ›å»ºæ–‡ä»¶
      const result = await ipcRenderer.invoke('prepare-file-for-drag', {
        fileName: `${note.title.replace(/[\\/:*?"<>|]/g, '_')}.txt`,
        content: textContent,
        noteId: noteId,
        requestId: uniqueId
      });
      
      if (result && result.success && !result.reused) {
        // æˆåŠŸåˆ›å»ºæ–‡ä»¶åï¼Œæ˜¾ç¤ºä¸€ä¸ªé€šçŸ¥
        showToast('æ–‡ä»¶å·²ä¿å­˜åˆ°æ¡Œé¢');
      }
    } catch (error) {
      console.error('å‡†å¤‡æ‹–æ‹½æ•°æ®å¤±è´¥:', error);
    }
  });

  // å¤„ç†æ‹–æ‹½ç»“æŸäº‹ä»¶
  notesList.addEventListener('dragend', function(event) {
    const noteItem = event.target.closest('.note-item');
    if (noteItem) {
      noteItem.classList.remove('dragging');
    }
  });
  
  // ä¸ºå½“å‰æŸ¥çœ‹çš„ç¬”è®°æ·»åŠ æ‹–æ‹½åŠŸèƒ½
  noteContentContainer.addEventListener('mousedown', function(event) {
    const titleArea = event.target.closest('#note-title-display');
    if (!titleArea || !currentNoteId) return;
    
    noteContentContainer.setAttribute('draggable', 'true');
    
    const mouseUpHandler = function() {
      noteContentContainer.removeAttribute('draggable');
      document.removeEventListener('mouseup', mouseUpHandler);
    };
    
    document.addEventListener('mouseup', mouseUpHandler);
  });

  // å¤„ç†å½“å‰ç¬”è®°çš„æ‹–æ‹½å¼€å§‹
  noteContentContainer.addEventListener('dragstart', async function(event) {
    const titleArea = event.target.closest('#note-title-display');
    if (!titleArea || !currentNoteId) return;
    
    try {
      // è·å–å½“å‰ç¬”è®°
      const note = await ipcRenderer.invoke('get-note', currentNoteId);
      if (!note) return;
      
      // å‡†å¤‡æ–‡æœ¬å†…å®¹
      let textContent = `${note.title}\n\n`;
      
      // ä»HTMLå†…å®¹ä¸­æå–çº¯æ–‡æœ¬
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = note.content;
      textContent += tempDiv.textContent || tempDiv.innerText || '';
      
      // è®¾ç½®åŸºç¡€æ–‡æœ¬æ•°æ®
      event.dataTransfer.setData('text/plain', textContent);
      event.dataTransfer.effectAllowed = 'copy';
      
      // åˆ›å»ºä¸€ä¸ªçœŸæ­£å”¯ä¸€çš„IDï¼ŒåŒ…å«ç¬”è®°IDç¡®ä¿ä¸åŒç¬”è®°ä¸ä¼šæ··æ·†
      const uniqueId = `content_${currentNoteId}_${Date.now()}`;
      
      // é€šçŸ¥ä¸»è¿›ç¨‹åˆ›å»ºæ–‡ä»¶
      const result = await ipcRenderer.invoke('prepare-file-for-drag', {
        fileName: `${note.title.replace(/[\\/:*?"<>|]/g, '_')}.txt`,
        content: textContent,
        noteId: currentNoteId,
        requestId: uniqueId
      });
      
      if (result && result.success && !result.reused) {
        showToast('æ–‡ä»¶å·²ä¿å­˜åˆ°æ¡Œé¢');
      }
    } catch (error) {
      console.error('å‡†å¤‡æ‹–æ‹½æ•°æ®å¤±è´¥:', error);
    }
  });
}

// å¯ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­çš„æ–‡å­—æ‹–æ‹½
function setupEditorDragExport(editor) {
  // ç›‘å¬é€‰æ‹©äº‹ä»¶
  editor.addEventListener('mouseup', function() {
    const selection = window.getSelection();
    if (selection.toString().trim() !== '') {
      editor.setAttribute('draggable', 'true');
      
      const clearDraggable = function() {
        editor.removeAttribute('draggable');
        editor.removeEventListener('dragend', clearDraggable);
        editor.removeEventListener('mousedown', clearDraggable);
      };
      
      editor.addEventListener('dragend', clearDraggable);
      editor.addEventListener('mousedown', clearDraggable);
    }
  });
  
  // æ‹–æ‹½é€‰ä¸­çš„æ–‡æœ¬
  editor.addEventListener('dragstart', async function(event) {
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    if (selectedText === '') return;
    
    // è®¾ç½®åŸºç¡€æ–‡æœ¬æ•°æ®
    event.dataTransfer.setData('text/plain', selectedText);
    event.dataTransfer.effectAllowed = 'copy';
    
    // åˆ›å»ºä¸€ä¸ªå”¯ä¸€IDï¼ŒåŒ…å«æ–‡æœ¬çš„å“ˆå¸Œå€¼éƒ¨åˆ†æ¥ç¡®ä¿å”¯ä¸€æ€§
    const textHash = selectedText.substr(0, 20).replace(/\s+/g, '_'); // ç®€å•ç”Ÿæˆæ–‡æœ¬çš„æ ‡è¯†
    const uniqueId = `selection_${textHash}_${Date.now()}`;
    
    // é€šçŸ¥ä¸»è¿›ç¨‹åˆ›å»ºæ–‡ä»¶
    const result = await ipcRenderer.invoke('prepare-file-for-drag', {
      fileName: `ç¬”è®°ç‰‡æ®µ_${new Date().toISOString().slice(0, 10)}.txt`,
      content: selectedText,
      requestId: uniqueId
    });
    
    if (result && result.success && !result.reused) {
      showToast('æ–‡ä»¶å·²ä¿å­˜åˆ°æ¡Œé¢');
    }
  });
}

// åœ¨åˆå§‹åŒ–å‡½æ•°æœ«å°¾è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥æ˜¾ç¤ºtoastæ¶ˆæ¯
function showToast(message, duration = 3000) {
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨toastå…ƒç´ 
  let toast = document.querySelector('.toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.className = 'toast';
    document.body.appendChild(toast);
  }
  
  // è®¾ç½®æ¶ˆæ¯å¹¶æ˜¾ç¤º
  toast.textContent = message;
  toast.classList.add('show');
  
  // è®¾ç½®è‡ªåŠ¨éšè—
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

// åœ¨DOMåŠ è½½å®Œæˆåæ·»åŠ æ ·å¼
document.addEventListener('DOMContentLoaded', () => {
  initApp();
  addGlobalStyles();
  addDragDropTipToDialog();
  addDragDropStyles();
});

// åˆ›å»ºèƒŒæ™¯å®¹å™¨
function createBackgroundContainer() {
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨èƒŒæ™¯å®¹å™¨
  if (!document.querySelector('.bg-container')) {
    const bgContainer = document.createElement('div');
    bgContainer.className = 'bg-container';
    document.body.insertBefore(bgContainer, document.body.firstChild);
    console.log('åˆ›å»ºèƒŒæ™¯å®¹å™¨æˆåŠŸ');
  } else {
    console.log('èƒŒæ™¯å®¹å™¨å·²å­˜åœ¨');
  }
}

// æ›´æ–°é€æ˜åº¦é¢„è§ˆ
function updateOpacityPreview() {
  const value = opacitySlider.value;
  opacityValue.textContent = `${value}%`;
}

// æ›´æ”¹çª—å£é€æ˜åº¦
async function changeOpacity() {
  const value = parseInt(opacitySlider.value);
  settings.opacity = value;
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    applyOpacity(value);
  } catch (error) {
    console.error('æ›´æ–°é€æ˜åº¦è®¾ç½®å¤±è´¥:', error);
  }
}

// åº”ç”¨é€æ˜åº¦
function applyOpacity(value) {
  document.body.style.opacity = value / 100;
  
  // åŒæ—¶é€šçŸ¥ä¸»è¿›ç¨‹æ›´æ–°çª—å£é€æ˜åº¦
  ipcRenderer.invoke('window-opacity', value / 100);
}

// æ›´æ–°å·¥å…·æ çŠ¶æ€
function updateToolbarState() {
  formatButtons.forEach(button => {
    const command = button.dataset.command;
    if (document.queryCommandState(command)) {
      button.classList.add('active');
    } else {
      button.classList.remove('active');
    }
  });
}

// æ”¾å¤§ç¼–è¾‘å™¨
function expandEditor() {
  expandedContent.innerHTML = noteEditor.innerHTML;
  expandedContainer.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

// æ”¶èµ·æ”¾å¤§æ¨¡å¼
function collapseEditor() {
  noteEditor.innerHTML = expandedContent.innerHTML;
  expandedContainer.classList.add('hidden');
  document.body.style.overflow = '';
  saveNoteContent();
}

// ä¿å­˜æ”¾å¤§æ¨¡å¼å†…å®¹
async function saveExpandedContent() {
  if (currentNoteId) {
    try {
      const content = expandedContent.innerHTML;
      const now = Date.now();
      await ipcRenderer.invoke('update-note', currentNoteId, content, now);
      
      // åŒæ­¥æ›´æ–°æ™®é€šç¼–è¾‘å™¨å†…å®¹
      noteEditor.innerHTML = content;
      
      // è§¦å‘è‡ªåŠ¨åŒæ­¥å¤‡ä»½
      ipcRenderer.send('note-updated', currentNoteId, content);
    } catch (error) {
      console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
    }
  }
}

// åŠ è½½è®¾ç½®
async function loadSettings() {
  try {
    settings = await ipcRenderer.invoke('get-settings');
    applyTheme(settings.theme);
    
    // åº”ç”¨æŠ˜å è®¾ç½®
    foldTitlesToggle.checked = settings.foldTitles;
    
    // åº”ç”¨é€æ˜åº¦è®¾ç½®
    if (settings.opacity !== undefined) {
      opacitySlider.value = settings.opacity;
      opacityValue.textContent = `${settings.opacity}%`;
      applyOpacity(settings.opacity);
    }
    
    // åº”ç”¨æœ€å¤§å±‚çº§è®¾ç½®
    if (maxLevelSlider && settings.maxLevel !== undefined) {
      maxLevelSlider.value = settings.maxLevel;
      maxLevelValue.textContent = settings.maxLevel;
    } else if (maxLevelSlider) {
      // é»˜è®¤å€¼ä¸º5
      maxLevelSlider.value = 5;
      maxLevelValue.textContent = '5';
      settings.maxLevel = 5;
    }
    
    // åº”ç”¨æœ€å¤§å­çº§æ•°é‡è®¾ç½®
    if (maxChildrenSlider && settings.maxChildren !== undefined) {
      maxChildrenSlider.value = settings.maxChildren === 0 ? 0 : settings.maxChildren;
      maxChildrenValue.textContent = settings.maxChildren === 0 ? 'æ— é™åˆ¶' : settings.maxChildren;
    } else if (maxChildrenSlider) {
      // é»˜è®¤å€¼ä¸º0ï¼ˆæ— é™åˆ¶ï¼‰
      maxChildrenSlider.value = 0;
      maxChildrenValue.textContent = 'æ— é™åˆ¶';
      settings.maxChildren = 0;
    }
    
    // åº”ç”¨è¡¨æƒ…åŒ…æç¤ºè®¾ç½®
    if (emojiTipsToggle) {
      emojiTipsToggle.checked = settings.emojiTips || false;
    }
    
    // åº”ç”¨æŒ‰é’®ä½ç½®è®¾ç½®
    if (settings.buttonPosition) {
      applyButtonPosition(settings.buttonPosition);
      
      // è®¾ç½®å¯¹åº”çš„å•é€‰æŒ‰é’®
      const positionRadio = document.getElementById(`position-${settings.buttonPosition}`);
      if (positionRadio) {
        positionRadio.checked = true;
      }
    } else {
      // é»˜è®¤ä¸ºå·¦ä¾§
      applyButtonPosition('left');
      if (positionLeftRadio) {
        positionLeftRadio.checked = true;
      }
    }
    
    // åº”ç”¨é“¾æ¥æ˜¾ç¤ºä½ç½®è®¾ç½®
    if (settings.linksDisplayPosition) {
      applyLinksDisplayPosition(settings.linksDisplayPosition);
      
      // è®¾ç½®å¯¹åº”çš„å•é€‰æŒ‰é’®
      const linksPositionRadio = document.getElementById(`links-position-${settings.linksDisplayPosition}`);
      if (linksPositionRadio) {
        linksPositionRadio.checked = true;
      }
    } else {
      // é»˜è®¤ä¸ºé»˜è®¤ä½ç½®
      applyLinksDisplayPosition('default');
      if (linksPositionDefaultRadio) {
        linksPositionDefaultRadio.checked = true;
      }
    }
    
    // åº”ç”¨èƒŒæ™¯è®¾ç½®
    if (settings.background) {
      console.log('åŠ è½½èƒŒæ™¯è®¾ç½®:', settings.background);
      
      // è®¾ç½®é€‰ä¸­çš„èƒŒæ™¯ç±»å‹
      const radioToCheck = document.querySelector(`input[name="background-type"][value="${settings.background.type}"]`);
      if (radioToCheck) {
        radioToCheck.checked = true;
      }
      
      // æ ¹æ®èƒŒæ™¯ç±»å‹æ˜¾ç¤ºå¯¹åº”é€‰é¡¹
      toggleBackgroundOptions();
      
      // è®¾ç½®å¯¹åº”çš„å€¼
      if (settings.background.type === 'color' && settings.background.value) {
        backgroundColorInput.value = settings.background.value;
      } else if (settings.background.type === 'url' && settings.background.value) {
        backgroundUrlInput.value = settings.background.value;
      } else if (settings.background.type === 'image' && settings.background.value) {
        // è®¾ç½®å·²é€‰å›¾ç‰‡åç§°
        const fileName = settings.background.value.split('/').pop();
        selectedImageName.textContent = fileName || 'å·²é€‰æ‹©å›¾ç‰‡';
      }
      
      // ç¡®ä¿é€æ˜åº¦å’Œæ¨¡ç³Šåº¦æœ‰é»˜è®¤å€¼
      if (settings.background.opacity === undefined) {
        settings.background.opacity = 100;
      }
      
      if (settings.background.blur === undefined) {
        settings.background.blur = 0;
      }
      
      if (settings.background.zIndex === undefined) {
        settings.background.zIndex = -1;
      }
      
      // è®¾ç½®é€æ˜åº¦å’Œæ¨¡ç³Šåº¦æ»‘å—
      bgOpacitySlider.value = settings.background.opacity;
      bgOpacityValue.textContent = `${settings.background.opacity}%`;
      
      bgBlurSlider.value = settings.background.blur;
      bgBlurValue.textContent = `${settings.background.blur}px`;
      
      bgZindexSlider.value = settings.background.zIndex;
      bgZindexValue.textContent = settings.background.zIndex;
      
      // åº”ç”¨èƒŒæ™¯
      applyBackground(settings.background);
    }
  } catch (error) {
    console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
  }
}

// åº”ç”¨ä¸»é¢˜
function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.classList.add('dark-theme');
    darkThemeBtn.classList.add('active');
    lightThemeBtn.classList.remove('active');
  } else {
    document.body.classList.remove('dark-theme');
    lightThemeBtn.classList.add('active');
    darkThemeBtn.classList.remove('active');
  }
}

// æ›´æ”¹ä¸»é¢˜
async function changeTheme(theme) {
  settings.theme = theme;
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    applyTheme(theme);
  } catch (error) {
    console.error('æ›´æ–°è®¾ç½®å¤±è´¥:', error);
  }
}

// åˆ‡æ¢æŠ˜å æ ‡é¢˜è®¾ç½®
async function toggleFoldTitles() {
  settings.foldTitles = foldTitlesToggle.checked;
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    renderNotesList(await ipcRenderer.invoke('get-notes'));
  } catch (error) {
    console.error('æ›´æ–°è®¾ç½®å¤±è´¥:', error);
  }
}

// å¤„ç†æ·»åŠ æŒ‰é’®ç‚¹å‡»
async function handleAddButtonClick() {
  if (selectedOutlineId) {
    // ä¸ºé€‰ä¸­çš„å¤§çº²æ·»åŠ å°æ ‡é¢˜
    isAddingSubnote = true;
    
    try {
      // è·å–é€‰ä¸­ç¬”è®°çš„ä¿¡æ¯ï¼Œæ˜¾ç¤ºçˆ¶ç¬”è®°çš„æ ‡é¢˜
      const parentNote = await ipcRenderer.invoke('get-note', selectedOutlineId);
      if (parentNote && parentNote.title) {
        addDialogTitle.textContent = `ä¸º"${parentNote.title}"æ·»åŠ å°æ ‡é¢˜`;
      } else {
        addDialogTitle.textContent = 'æ·»åŠ å°æ ‡é¢˜';
      }
    } catch (error) {
      console.error('è·å–çˆ¶ç¬”è®°ä¿¡æ¯å¤±è´¥:', error);
      addDialogTitle.textContent = 'æ·»åŠ å°æ ‡é¢˜';
    }
    
    showAddNoteDialog();
  } else {
    // æ·»åŠ æ–°å¤§çº²
    isAddingSubnote = false;
    addDialogTitle.textContent = 'æ·»åŠ æ–°ç¬”è®°';
    showAddNoteDialog();
  }
}

// ç¡®è®¤æ·»åŠ ç¬”è®°
async function handleConfirmAdd() {
  const title = noteTitleInput.value.trim();
  if (title) {
    try {
      if (isAddingSubnote && selectedOutlineId) {
        // æ£€æŸ¥å½“å‰é€‰ä¸­ç¬”è®°çš„å±‚çº§ï¼Œå¦‚æœå·²ç»è¾¾åˆ°æœ€å¤§å±‚çº§é™åˆ¶ï¼Œåˆ™æ— æ³•æ·»åŠ å­ç¬”è®°
        if (selectedNoteLevel >= settings.maxLevel) {
          showToast(`æ— æ³•æ·»åŠ æ›´å¤šå­ç¬”è®°ï¼Œå·²è¾¾åˆ°æœ€å¤§å±‚çº§é™åˆ¶(${settings.maxLevel}çº§)`);
          hideAddNoteDialog();
          return;
        }
        
        // æ·»åŠ å°æ ‡é¢˜
        const newSubnote = await ipcRenderer.invoke('add-subnote', selectedOutlineId, title);
        
        // æ£€æŸ¥æ˜¯å¦æˆåŠŸæ·»åŠ 
        if (newSubnote && newSubnote.error) {
          showToast(newSubnote.error);
          hideAddNoteDialog();
          return;
        }
        
        // æ·»åŠ æˆåŠŸçš„æç¤ºï¼ŒåŒ…å«çº§åˆ«ä¿¡æ¯
        const newLevel = selectedNoteLevel + 1;
        showToast(`æˆåŠŸæ·»åŠ "${title}"(${newLevel}çº§)`);
        
        hideAddNoteDialog();
        await loadNotes();
        if (newSubnote && newSubnote.id) {
          openNote(newSubnote.id);
        }
      } else {
        // æ·»åŠ å¤§çº²æ ‡é¢˜
        const newOutline = await ipcRenderer.invoke('add-outline', title);
        
        if (newOutline) {
          showToast(`æˆåŠŸæ·»åŠ "${title}"(1çº§)`);
          hideAddNoteDialog();
          await loadNotes();
          openNote(newOutline.id);
        } else {
          showToast('æ·»åŠ ç¬”è®°å¤±è´¥');
          hideAddNoteDialog();
        }
      }
    } catch (error) {
      console.error('æ·»åŠ ç¬”è®°å¤±è´¥:', error);
      showToast('æ·»åŠ ç¬”è®°å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      hideAddNoteDialog();
    }
  }
}

// åŠ è½½æ‰€æœ‰ç¬”è®°
async function loadNotes() {
  try {
    const notes = await ipcRenderer.invoke('get-notes');
    renderNotesList(notes);
  } catch (error) {
    console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
  }
}

// æ¸²æŸ“ç¬”è®°åˆ—è¡¨
function renderNotesList(notes) {
  notesList.innerHTML = '';
  selectedOutlineId = null;
  selectedNoteLevel = 1;
  selectedNoteType = null;
  
  if (notes.length === 0) {
    notesList.innerHTML = '<div class="empty-state">æš‚æ— ç¬”è®°ï¼Œç‚¹å‡»å³ä¸‹è§’"æ·»åŠ "æŒ‰é’®åˆ›å»º</div>';
    return;
  }
  
  // æŒ‰åˆ›å»ºæ—¶é—´ä»æ–°åˆ°æ—§æ’åº
  notes.sort((a, b) => b.created - a.created);
  
  // é€’å½’æ¸²æŸ“ç¬”è®°åŠå…¶å­ç¬”è®°
  const renderNote = (note, container, level = 1, parentClass = '') => {
    const hasChildren = note.children && note.children.length > 0;
    
    // åˆ›å»ºç¬”è®°é¡¹
    const noteItem = document.createElement('div');
    noteItem.className = `note-item ${hasChildren ? 'outline' : ''} ${parentClass} level-${level}`;
    if (settings.foldTitles && hasChildren) {
      noteItem.classList.add('collapsed');
    }
    noteItem.dataset.id = note.id;
    noteItem.dataset.type = note.type || 'outline';
    noteItem.dataset.level = level;
    
    // åº”ç”¨èƒŒæ™¯é¢œè‰²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (note.metadata && note.metadata.bgColor) {
      noteItem.style.backgroundColor = note.metadata.bgColor;
      noteItem.classList.add('custom-bg');
    }
    
    // åˆ›å»ºæ ‡é¢˜å’Œæ—¥æœŸ
    let toggleHtml = hasChildren ? 
      `<span class="outline-toggle">${settings.foldTitles ? 'â–¶' : 'â–¼'}</span>` : '';
    
    // æ·»åŠ çº§åˆ«æ ‡å¿—
    const levelBadge = `<span class="level-badge">${level}çº§</span>`;
    
    // æ·»åŠ åˆ›å»ºæ—¶é—´å’Œæœ€åæ›´æ–°æ—¶é—´ï¼ˆå¯¹æ‰€æœ‰ç¬”è®°ï¼ŒåŒ…æ‹¬å­ç¬”è®°ï¼‰
    const createdDate = formatDate(note.created);
    const updatedDate = note.updated ? formatDate(note.updated) : createdDate;
    const timeInfo = note.updated ? 
      `åˆ›å»ºäº: ${createdDate} | æœ€åæ›´æ–°: ${updatedDate}` : 
      `åˆ›å»ºäº: ${createdDate}`;
    
    noteItem.innerHTML = `
      <h3>${toggleHtml}<span class="note-title-text">${escapeHtml(note.title)}</span>${levelBadge}</h3>
      <div class="note-date">${timeInfo}</div>
      <button class="delete-btn" title="åˆ é™¤">Ã—</button>
    `;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    noteItem.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-btn')) {
        e.stopPropagation();
        showDeleteConfirmDialog(note.id, note.type || 'outline');
      } else if (e.target.classList.contains('outline-toggle')) {
        e.stopPropagation();
        toggleOutlineCollapse(noteItem);
      } else {
        selectOutline(note.id, level);
        openNote(note.id);
      }
    });
    
    // æ·»åŠ åŒå‡»æ ‡é¢˜ä¿®æ”¹åŠŸèƒ½
    const titleText = noteItem.querySelector('.note-title-text');
    titleText.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      startTitleEdit(note.id, titleText);
    });
    
    container.appendChild(noteItem);
    
    // ä¸ºå­ç¬”è®°åˆ›å»ºå®¹å™¨
    if (hasChildren) {
      const subnoteContainer = document.createElement('div');
      subnoteContainer.className = 'subnotes-container';
      
      // é€’å½’æ¸²æŸ“å­ç¬”è®°
      note.children.sort((a, b) => b.created - a.created); // å­ç¬”è®°ä¹ŸæŒ‰æ—¶é—´æ’åº
      
      // åº”ç”¨å­çº§æ•°é‡é™åˆ¶
      let childrenToRender = note.children;
      if (settings.maxChildren > 0) {
        // å¦‚æœè®¾ç½®äº†é™åˆ¶ä¸”ä¸ä¸º0ï¼Œåˆ™é™åˆ¶å­çº§æ•°é‡
        childrenToRender = note.children.slice(0, settings.maxChildren);
        
        // å¦‚æœæœ‰æ›´å¤šå­çº§ä½†è¢«é™åˆ¶äº†ï¼Œæ˜¾ç¤ºæç¤º
        if (note.children.length > settings.maxChildren) {
          const limitMessage = document.createElement('div');
          limitMessage.className = 'children-limit-message';
          limitMessage.textContent = `ä»…æ˜¾ç¤º ${settings.maxChildren}/${note.children.length} ä¸ªå­æ ‡é¢˜ (å·²è¾¾åˆ°é™åˆ¶)`;
          subnoteContainer.appendChild(limitMessage);
        }
      }
      
      childrenToRender.forEach(subnote => {
        // æ£€æŸ¥å±‚çº§é™åˆ¶ï¼Œä½¿ç”¨è®¾ç½®ä¸­çš„æœ€å¤§å±‚çº§
        if (level < settings.maxLevel) {
          renderNote(
            subnote, 
            subnoteContainer, 
            (subnote.level || level + 1), 
            'subnote'
          );
        }
      });
      
      // æ·»åŠ æ–°çš„å±‚çº§é™åˆ¶æç¤º
      if (level === settings.maxLevel - 1 && childrenToRender.length > 0) {
        const levelLimitMessage = document.createElement('div');
        levelLimitMessage.className = 'children-limit-message';
        levelLimitMessage.textContent = `æœ€å¤§å±‚çº§é™åˆ¶ä¸º${settings.maxLevel}çº§ï¼Œæ›´æ”¹è®¾ç½®å¯æŸ¥çœ‹æ›´å¤šå±‚çº§`;
        subnoteContainer.appendChild(levelLimitMessage);
      }
      
      container.appendChild(subnoteContainer);
    }
  };
  
  // æ¸²æŸ“é¡¶å±‚ç¬”è®°
  notes.forEach(note => {
    renderNote(note, notesList, note.level || 1);
  });
}

// åˆ‡æ¢å¤§çº²æŠ˜å çŠ¶æ€
function toggleOutlineCollapse(outlineItem) {
  outlineItem.classList.toggle('collapsed');
  
  // æ›´æ–°æŠ˜å å›¾æ ‡
  const toggleIcon = outlineItem.querySelector('.outline-toggle');
  if (toggleIcon) {
    toggleIcon.textContent = outlineItem.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
  }
}

// é€‰ä¸­å¤§çº²
function selectOutline(id, level) {
  // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
  document.querySelectorAll('.note-item.selected').forEach(item => {
    item.classList.remove('selected');
  });
  
  // æ·»åŠ æ–°çš„é€‰ä¸­çŠ¶æ€
  const outlineItem = document.querySelector(`.note-item[data-id="${id}"]`);
  if (outlineItem) {
    outlineItem.classList.add('selected');
    selectedOutlineId = id;
    
    // ä¿å­˜å½“å‰é€‰ä¸­ç¬”è®°çš„å±‚çº§å’Œç±»å‹ä¿¡æ¯
    selectedNoteLevel = parseInt(outlineItem.dataset.level) || level;
    selectedNoteType = outlineItem.dataset.type || 'outline';
    
    // å¦‚æœè¯¥å¤§çº²æœ‰å­ç¬”è®°ï¼Œå¹¶ä¸”æ˜¯æŠ˜å çŠ¶æ€ï¼Œåˆ™å±•å¼€
    if (outlineItem.classList.contains('outline') && outlineItem.classList.contains('collapsed')) {
      toggleOutlineCollapse(outlineItem);
    }
    
    // ç¡®ä¿æ‰€æœ‰çˆ¶çº§å®¹å™¨éƒ½å±•å¼€
    let parent = outlineItem.parentElement;
    while (parent && parent.classList.contains('subnotes-container')) {
      const parentItem = parent.previousElementSibling;
      if (parentItem && parentItem.classList.contains('collapsed')) {
        toggleOutlineCollapse(parentItem);
      }
      parent = parent.parentElement;
    }
  }
}

// æ‰“å¼€ç¬”è®°
async function openNote(id) {
  try {
    const note = await ipcRenderer.invoke('get-note', id);
    if (note) {
      currentNoteId = note.id;
      currentNoteType = note.type || 'outline';
      noteTitleDisplay.textContent = note.title;
      noteEditor.innerHTML = note.content;
      
      // åº”ç”¨ä¿å­˜çš„æ ‡é¢˜é¢œè‰²
      if (note.metadata && note.metadata.titleColor) {
        noteTitleDisplay.style.color = note.metadata.titleColor;
      } else {
        // é‡ç½®ä¸ºé»˜è®¤é¢œè‰²
        noteTitleDisplay.style.color = '';
      }
      
      // åº”ç”¨èƒŒæ™¯é¢œè‰²åˆ°ç¬”è®°é¡¹ç›®ï¼ˆåœ¨åˆ—è¡¨ä¸­ï¼‰
      if (note.metadata && note.metadata.bgColor) {
        const noteItem = document.querySelector(`.note-item[data-id="${id}"]`);
        if (noteItem) {
          noteItem.style.backgroundColor = note.metadata.bgColor;
          noteItem.classList.add('custom-bg');
        }
      }
      
      notesListContainer.classList.add('viewing-note');
      noteContentContainer.classList.remove('hidden');
      
      // æ¯æ¬¡æ‰“å¼€ç¬”è®°æ—¶æ›´æ–°å·¥å…·æ çŠ¶æ€
      updateToolbarState();
      
      // éšè—åˆ—è¡¨è§†å›¾ä¸­çš„æ—¶é—´ä¿¡æ¯
      const allNoteDates = document.querySelectorAll('.note-date');
      allNoteDates.forEach(dateEl => {
        dateEl.classList.add('hidden');
      });
    }
  } catch (error) {
    console.error('è·å–ç¬”è®°å¤±è´¥:', error);
  }
}

// æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
function showDeleteConfirmDialog(id, type) {
  const message = type === 'outline' 
    ? 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç¬”è®°åŠå…¶æ‰€æœ‰å°æ ‡é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚' 
    : 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå°æ ‡é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚';
  
  confirmMessage.textContent = message;
  confirmDialog.classList.remove('hidden');
  
  // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„äº‹ä»¶
  confirmOkBtn.onclick = async () => {
    await deleteNote(id, type);
    hideConfirmDialog();
  };
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  confirmDialog.addEventListener('click', closeConfirmDialogOnBlankClick);
}

// éšè—ç¡®è®¤å¯¹è¯æ¡†
function hideConfirmDialog() {
  confirmDialog.classList.add('hidden');
  confirmOkBtn.onclick = null;
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  confirmDialog.removeEventListener('click', closeConfirmDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­ç¡®è®¤å¯¹è¯æ¡†
function closeConfirmDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === confirmDialog) {
    hideConfirmDialog();
  }
}

// åˆ é™¤ç¬”è®°
async function deleteNote(id, type) {
  try {
    const result = await ipcRenderer.invoke('delete-note', id);
    if (result) {
      if (currentNoteId === id) {
        showNotesList();
      }
      
      if (selectedOutlineId === id) {
        selectedOutlineId = null;
        selectedNoteLevel = 1;
        selectedNoteType = null;
      }
      
      await loadNotes();
    }
  } catch (error) {
    console.error('åˆ é™¤ç¬”è®°å¤±è´¥:', error);
  }
}

// ä¿å­˜ç¬”è®°å†…å®¹
async function saveNoteContent() {
  if (currentNoteId) {
    try {
      const content = noteEditor.innerHTML;
      const now = Date.now();
      await ipcRenderer.invoke('update-note', currentNoteId, content, now);
      
      // è§¦å‘è‡ªåŠ¨åŒæ­¥å¤‡ä»½
      ipcRenderer.send('note-updated', currentNoteId, content);
    } catch (error) {
      console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
    }
  }
}

// æ˜¾ç¤ºç¬”è®°åˆ—è¡¨ï¼ˆè¿”å›ï¼‰
function showNotesList() {
  currentNoteId = null;
  currentNoteType = null;
  notesListContainer.classList.remove('viewing-note');
  noteContentContainer.classList.add('hidden');
  
  // æ˜¾ç¤ºæ‰€æœ‰æ—¶é—´ä¿¡æ¯
  const allNoteDates = document.querySelectorAll('.note-date');
  allNoteDates.forEach(dateEl => {
    dateEl.classList.remove('hidden');
  });
  
  // å¦‚æœæ”¾å¤§æ¨¡å¼æ‰“å¼€ï¼Œä¹Ÿå…³é—­å®ƒ
  if (!expandedContainer.classList.contains('hidden')) {
    collapseEditor();
  }
}

// æ˜¾ç¤ºæ·»åŠ ç¬”è®°å¯¹è¯æ¡†
function showAddNoteDialog() {
  addNoteDialog.classList.remove('hidden');
  noteTitleInput.value = '';
  noteTitleInput.focus();
  
  // æ·»åŠ æ‹–æ‹½æ–‡æœ¬æ–‡ä»¶æ”¯æŒ
  setupTxtFileDragDrop();
  
  // ç¡®ä¿æ˜¾ç¤ºæ‹–æ‹½æç¤ºæ–‡æœ¬
  addDragDropTipToDialog();
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  addNoteDialog.addEventListener('click', closeAddNoteDialogOnBlankClick);
}

// éšè—æ·»åŠ ç¬”è®°å¯¹è¯æ¡†
function hideAddNoteDialog() {
  addNoteDialog.classList.add('hidden');
  isAddingSubnote = false;
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  addNoteDialog.removeEventListener('click', closeAddNoteDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ·»åŠ ç¬”è®°å¯¹è¯æ¡†
function closeAddNoteDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === addNoteDialog) {
    hideAddNoteDialog();
  }
}

// æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
function showSettingsDialog() {
  settingsDialog.classList.remove('hidden');
  
  // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç‚¹å‡»ç©ºç™½å¤„å…³é—­è®¾ç½®é¡µé¢
  settingsDialog.addEventListener('click', closeSettingsOnBlankClick);
}

// éšè—è®¾ç½®å¯¹è¯æ¡†
function hideSettingsDialog() {
  settingsDialog.classList.add('hidden');
  
  // ç§»é™¤ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
  settingsDialog.removeEventListener('click', closeSettingsOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­è®¾ç½®é¡µé¢
function closeSettingsOnBlankClick(event) {
  // å¦‚æœç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼Œè€Œä¸æ˜¯å¯¹è¯æ¡†å†…å®¹
  if (event.target === settingsDialog) {
    hideSettingsDialog();
  }
}

// å¤„ç†æ‹–æ‹½æ–‡ä»¶è¿›å…¥äº‹ä»¶
function handleDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
}

// å¤„ç†æ‹–æ‹½æ–‡ä»¶æ”¾ç½®äº‹ä»¶
async function handleDrop(event) {
  event.preventDefault();
  event.stopPropagation();
  
  if (event.dataTransfer.files.length > 0) {
    const files = event.dataTransfer.files;
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      if (file.type.startsWith('image/')) {
        await handleImageFile(file, event.target === expandedContent);
      }
    }
  }
}

// å¤„ç†å›¾ç‰‡æ–‡ä»¶
async function handleImageFile(file, isExpanded) {
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    const dataUrl = e.target.result;
    
    try {
      const imageInfo = await ipcRenderer.invoke('save-image', dataUrl);
      if (imageInfo) {
        // æ ¹æ®å½“å‰ç¼–è¾‘åŒºåŸŸæ’å…¥å›¾ç‰‡
        if (isExpanded) {
          insertImageAtCursorExpanded(imageInfo.filePath);
        } else {
          insertImageAtCursor(imageInfo.filePath);
        }
        
        // ä¿å­˜æ›´æ”¹
        if (isExpanded) {
          await saveExpandedContent();
        } else {
          await saveNoteContent();
        }
      }
    } catch (error) {
      console.error('å¤„ç†å›¾ç‰‡å¤±è´¥:', error);
    }
  };
  
  reader.readAsDataURL(file);
}

// åœ¨å…‰æ ‡ä½ç½®æ’å…¥å›¾ç‰‡
function insertImageAtCursor(imagePath) {
  const img = document.createElement('img');
  img.src = imagePath;
  img.alt = 'ç¬”è®°å›¾ç‰‡';
  
  const selection = window.getSelection();
  if (selection.rangeCount > 0) {
    const range = selection.getRangeAt(0);
    range.insertNode(img);
    range.setStartAfter(img);
    range.setEndAfter(img);
    selection.removeAllRanges();
    selection.addRange(range);
  } else {
    noteEditor.appendChild(img);
  }
}

// åœ¨æ”¾å¤§æ¨¡å¼ä¸‹åœ¨å…‰æ ‡ä½ç½®æ’å…¥å›¾ç‰‡
function insertImageAtCursorExpanded(imagePath) {
  const img = document.createElement('img');
  img.src = imagePath;
  img.alt = 'ç¬”è®°å›¾ç‰‡';
  
  const selection = window.getSelection();
  if (selection.rangeCount > 0) {
    const range = selection.getRangeAt(0);
    range.insertNode(img);
    range.setStartAfter(img);
    range.setEndAfter(img);
    selection.removeAllRanges();
    selection.addRange(range);
  } else {
    expandedContent.appendChild(img);
  }
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(timestamp) {
  const date = new Date(timestamp);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}

// é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
  let timeout;
  return function(...args) {
    const context = this;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), wait);
  };
}

// HTMLè½¬ä¹‰ï¼Œé˜²æ­¢XSS
function escapeHtml(html) {
  const div = document.createElement('div');
  div.textContent = html;
  return div.innerHTML;
}

// åˆ‡æ¢èƒŒæ™¯é€‰é¡¹æ˜¾ç¤º
function toggleBackgroundOptions() {
  const selectedType = document.querySelector('input[name="background-type"]:checked').value;
  
  console.log('é€‰æ‹©èƒŒæ™¯ç±»å‹:', selectedType);
  
  // éšè—æ‰€æœ‰é€‰é¡¹
  backgroundColorContainer.classList.add('hidden');
  backgroundImageContainer.classList.add('hidden');
  backgroundUrlContainer.classList.add('hidden');
  
  // æ ¹æ®ç±»å‹æ˜¾ç¤ºç›¸åº”çš„é€‰é¡¹
  if (selectedType === 'color') {
    backgroundColorContainer.classList.remove('hidden');
    backgroundAdjustments.classList.remove('hidden');
  } else if (selectedType === 'image') {
    backgroundImageContainer.classList.remove('hidden');
    backgroundAdjustments.classList.remove('hidden');
  } else if (selectedType === 'url') {
    backgroundUrlContainer.classList.remove('hidden');
    backgroundAdjustments.classList.remove('hidden');
  } else {
    // å¦‚æœé€‰æ‹©"æ— èƒŒæ™¯"ï¼Œåˆ™éšè—è°ƒæ•´é€‰é¡¹
    backgroundAdjustments.classList.add('hidden');
  }
  
  // æ›´æ–°è®¾ç½®
  settings.background.type = selectedType;
  updateBackgroundSettings();
}

// æ›´æ–°èƒŒæ™¯é€æ˜åº¦é¢„è§ˆ
function updateBgOpacityPreview() {
  const value = bgOpacitySlider.value;
  bgOpacityValue.textContent = `${value}%`;
}

// æ›´æ–°èƒŒæ™¯æ¨¡ç³Šåº¦é¢„è§ˆ
function updateBgBlurPreview() {
  const value = bgBlurSlider.value;
  bgBlurValue.textContent = `${value}px`;
}

// æ›´æ–°èƒŒæ™¯æ˜¾ç¤ºå±‚çº§é¢„è§ˆ
function updateBgZindexPreview() {
  const value = bgZindexSlider.value;
  bgZindexValue.textContent = value;
}

// æ›´æ–°èƒŒæ™¯é¢œè‰²
function updateBackgroundColor() {
  settings.background.value = backgroundColorInput.value;
  updateBackgroundSettings();
}

// é€‰æ‹©èƒŒæ™¯å›¾ç‰‡
async function chooseBackgroundImage() {
  try {
    const result = await ipcRenderer.invoke('choose-background-image');
    console.log('é€‰æ‹©èƒŒæ™¯å›¾ç‰‡ç»“æœ:', result);
    if (result.success) {
      settings.background.value = result.path;
      selectedImageName.textContent = result.fileName || 'å·²é€‰æ‹©å›¾ç‰‡';
      updateBackgroundSettings();
    }
  } catch (error) {
    console.error('é€‰æ‹©èƒŒæ™¯å›¾ç‰‡å¤±è´¥:', error);
  }
}

// æ›´æ–°èƒŒæ™¯URL
function updateBackgroundUrl() {
  settings.background.value = backgroundUrlInput.value;
  updateBackgroundSettings();
}

// æ›´æ–°èƒŒæ™¯è®¾ç½®
async function updateBackgroundSettings() {
  try {
    // æ›´æ–°é€æ˜åº¦ã€æ¨¡ç³Šåº¦å’Œæ˜¾ç¤ºå±‚çº§è®¾ç½®
    settings.background.opacity = parseInt(bgOpacitySlider.value);
    settings.background.blur = parseInt(bgBlurSlider.value);
    settings.background.zIndex = parseInt(bgZindexSlider.value);
    
    console.log('æ›´æ–°èƒŒæ™¯è®¾ç½®:', settings.background);
    await ipcRenderer.invoke('update-settings', settings);
    applyBackground(settings.background);
  } catch (error) {
    console.error('æ›´æ–°èƒŒæ™¯è®¾ç½®å¤±è´¥:', error);
  }
}

// åº”ç”¨èƒŒæ™¯
function applyBackground(backgroundSettings) {
  const bgContainer = document.querySelector('.bg-container');
  if (!bgContainer) {
    console.error('èƒŒæ™¯å®¹å™¨ä¸å­˜åœ¨');
    return;
  }
  
  // ç§»é™¤æ‰€æœ‰èƒŒæ™¯ç›¸å…³æ ·å¼
  bgContainer.style.backgroundImage = '';
  bgContainer.style.backgroundColor = '';
  bgContainer.style.opacity = '';
  bgContainer.style.backdropFilter = '';
  bgContainer.style.webkitBackdropFilter = '';
  bgContainer.style.filter = '';
  
  // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç±»å
  bgContainer.classList.remove('above-content');
  
  console.log('åº”ç”¨èƒŒæ™¯è®¾ç½®:', backgroundSettings);
  
  // æ ¹æ®è®¾ç½®åº”ç”¨èƒŒæ™¯
  if (backgroundSettings.type === 'none') {
    bgContainer.style.display = 'none';
    return;
  }
  
  bgContainer.style.display = 'block';
  
  // è®¾ç½®é€æ˜åº¦
  const opacity = backgroundSettings.opacity !== undefined ? backgroundSettings.opacity / 100 : 1;
  bgContainer.style.opacity = opacity;
  
  // è®¾ç½®æ¨¡ç³Šåº¦
  const blur = backgroundSettings.blur !== undefined ? backgroundSettings.blur : 0;
  if (blur > 0) {
    // æ³¨æ„ï¼šæ¨¡ç³Šæ•ˆæœåº”è¯¥åº”ç”¨åœ¨èƒŒæ™¯å›¾ç‰‡ä¸Šï¼Œè€Œä¸æ˜¯æ•´ä¸ªå®¹å™¨
    bgContainer.style.filter = `blur(${blur}px)`;
  }
  
  // è®¾ç½®æ˜¾ç¤ºå±‚çº§
  const zIndex = backgroundSettings.zIndex !== undefined ? backgroundSettings.zIndex : -1;
  bgContainer.style.zIndex = zIndex;
  console.log('è®¾ç½®èƒŒæ™¯å±‚çº§:', zIndex);
  
  // å¦‚æœå±‚çº§å¤§äº0ï¼Œæ·»åŠ above-contentç±»
  if (zIndex > 0) {
    bgContainer.classList.add('above-content');
    console.log('èƒŒæ™¯æ˜¾ç¤ºåœ¨å†…å®¹ä¹‹ä¸Š');
  }
  
  if (backgroundSettings.type === 'color' && backgroundSettings.value) {
    bgContainer.style.backgroundColor = backgroundSettings.value;
    console.log('åº”ç”¨çº¯è‰²èƒŒæ™¯:', backgroundSettings.value);
  } else if (backgroundSettings.type === 'image' && backgroundSettings.value) {
    // ç¡®ä¿å›¾ç‰‡è·¯å¾„æ­£ç¡®å¤„ç†
    console.log('åº”ç”¨èƒŒæ™¯å›¾ç‰‡:', backgroundSettings.value);
    
    // å°è¯•ä¸åŒçš„URLæ ¼å¼
    let imagePath = backgroundSettings.value;
    
    // å¦‚æœè·¯å¾„ä¸æ˜¯ä»¥file:///å¼€å¤´ï¼Œå°è¯•æ·»åŠ 
    if (!imagePath.startsWith('file:///') && !imagePath.startsWith('http')) {
      if (process.platform === 'win32') {
        imagePath = 'file:///' + imagePath.replace(/\\/g, '/');
      } else {
        imagePath = 'file://' + imagePath;
      }
    }
    
    // å°è¯•ç›´æ¥è®¾ç½®èƒŒæ™¯
    bgContainer.style.backgroundImage = `url("${imagePath}")`;
    
    // æ·»åŠ é”™è¯¯å¤„ç†
    const testImg = new Image();
    testImg.onerror = () => {
      console.error('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•æ›¿ä»£è·¯å¾„');
      
      // å°è¯•æ›¿ä»£è·¯å¾„
      const alternativePath = imagePath.replace('file:///', '');
      bgContainer.style.backgroundImage = `url("${alternativePath}")`;
      
      // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•ç›¸å¯¹è·¯å¾„
      testImg.onerror = () => {
        console.error('æ›¿ä»£è·¯å¾„ä¹Ÿå¤±è´¥ï¼Œå°è¯•ç›¸å¯¹è·¯å¾„');
        const relativePath = backgroundSettings.value.split('/').pop();
        bgContainer.style.backgroundImage = `url("${relativePath}")`;
      };
      testImg.src = alternativePath;
    };
    testImg.src = imagePath;
    
  } else if (backgroundSettings.type === 'url' && backgroundSettings.value) {
    // ç¡®ä¿URLè·¯å¾„æ­£ç¡®å¤„ç†
    console.log('åº”ç”¨URLèƒŒæ™¯:', backgroundSettings.value);
    bgContainer.style.backgroundImage = `url("${backgroundSettings.value}")`;
  }
}

// æ˜¾ç¤ºå¤‡ä»½ç¬”è®°é€‰æ‹©å¯¹è¯æ¡†
async function showBackupNotesDialog() {
  try {
    // é‡ç½®é€‰ä¸­çš„ç¬”è®°
    selectedBackupNotes = [];
    backupNotesList.innerHTML = '';
    
    // è·å–æ‰€æœ‰ç¬”è®°
    const notes = await ipcRenderer.invoke('get-notes');
    
    if (notes.length === 0) {
      backupNotesList.innerHTML = '<div class="empty-state">æš‚æ— ç¬”è®°å¯ä¾›å¤‡ä»½</div>';
    } else {
      // æ¸²æŸ“ç¬”è®°åˆ—è¡¨ä»¥ä¾›é€‰æ‹©
      notes.forEach(note => {
        // åˆ›å»ºå¤§çº²é¡¹
        const noteItem = document.createElement('div');
        noteItem.className = 'backup-note-item';
        
        noteItem.innerHTML = `
          <label>
            <input type="checkbox" data-id="${note.id}">
            ${escapeHtml(note.title)}
          </label>
        `;
        
        backupNotesList.appendChild(noteItem);
        
        // å¦‚æœæœ‰å­ç¬”è®°ï¼Œä¹Ÿæ˜¾ç¤ºå®ƒä»¬
        if (note.children && note.children.length > 0) {
          note.children.forEach(subnote => {
            const subnoteItem = document.createElement('div');
            subnoteItem.className = 'backup-note-item backup-subnote';
            
            subnoteItem.innerHTML = `
              <label>
                <input type="checkbox" data-id="${subnote.id}">
                ${escapeHtml(subnote.title)}
              </label>
            `;
            
            backupNotesList.appendChild(subnoteItem);
          });
        }
      });
      
      // æ·»åŠ å…¨é€‰åŠŸèƒ½
      const selectAllItem = document.createElement('div');
      selectAllItem.className = 'backup-note-item';
      selectAllItem.style.borderColor = '#999';
      selectAllItem.style.marginBottom = '10px';
      
      selectAllItem.innerHTML = `
        <label>
          <input type="checkbox" id="select-all-notes">
          <strong>å…¨é€‰</strong>
        </label>
      `;
      
      // å°†å…¨é€‰é¡¹æ’å…¥åˆ°åˆ—è¡¨å¼€å¤´
      backupNotesList.insertBefore(selectAllItem, backupNotesList.firstChild);
      
      // æ·»åŠ å…¨é€‰äº‹ä»¶
      const selectAllCheckbox = document.getElementById('select-all-notes');
      selectAllCheckbox.addEventListener('change', function() {
        const checkboxes = backupNotesList.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          if (checkbox !== selectAllCheckbox) {
            checkbox.checked = selectAllCheckbox.checked;
            
            // æ›´æ–°é€‰ä¸­çš„ç¬”è®°IDåˆ—è¡¨
            if (selectAllCheckbox.checked) {
              if (checkbox.dataset.id && !selectedBackupNotes.includes(checkbox.dataset.id)) {
                selectedBackupNotes.push(checkbox.dataset.id);
              }
            } else {
              selectedBackupNotes = [];
            }
          }
        });
      });
      
      // æ·»åŠ å•ä¸ªç¬”è®°é€‰æ‹©äº‹ä»¶
      const noteCheckboxes = backupNotesList.querySelectorAll('input[type="checkbox"][data-id]');
      noteCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const noteId = checkbox.dataset.id;
          
          if (checkbox.checked) {
            if (!selectedBackupNotes.includes(noteId)) {
              selectedBackupNotes.push(noteId);
            }
          } else {
            selectedBackupNotes = selectedBackupNotes.filter(id => id !== noteId);
            // å–æ¶ˆå…¨é€‰
            document.getElementById('select-all-notes').checked = false;
          }
        });
      });
    }
    
    // æ˜¾ç¤ºå¯¹è¯æ¡†
    hideSettingsDialog();
    backupNotesDialog.classList.remove('hidden');
    
    // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
    backupNotesDialog.addEventListener('click', closeBackupNotesDialogOnBlankClick);
  } catch (error) {
    console.error('å‡†å¤‡å¤‡ä»½å¯¹è¯æ¡†å¤±è´¥:', error);
  }
}

// éšè—å¤‡ä»½ç¬”è®°é€‰æ‹©å¯¹è¯æ¡†
function hideBackupNotesDialog() {
  backupNotesDialog.classList.add('hidden');
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  backupNotesDialog.removeEventListener('click', closeBackupNotesDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¤‡ä»½ç¬”è®°é€‰æ‹©å¯¹è¯æ¡†
function closeBackupNotesDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === backupNotesDialog) {
    hideBackupNotesDialog();
  }
}

// æ˜¾ç¤ºå¤‡ä»½è·¯å¾„è®¾ç½®å¯¹è¯æ¡†
function showBackupPathDialog() {
  // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„ç¬”è®°
  if (selectedBackupNotes.length === 0) {
    // ä½¿ç”¨ä¸è½¯ä»¶é£æ ¼ä¸€è‡´çš„æç¤º
    confirmMessage.textContent = 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç¬”è®°è¿›è¡Œå¤‡ä»½';
    confirmDialog.classList.remove('hidden');
    confirmOkBtn.textContent = 'ç¡®å®š';
    confirmOkBtn.onclick = hideConfirmDialog;
    return;
  }
  
  // é‡ç½®è·¯å¾„è¾“å…¥æ¡†å’Œè‡ªåŠ¨åŒæ­¥å¼€å…³
  backupPathInput.value = '';
  autoSyncToggle.checked = false;
  
  // éšè—ä¸Šä¸€ä¸ªå¯¹è¯æ¡†å¹¶æ˜¾ç¤ºè·¯å¾„å¯¹è¯æ¡†
  hideBackupNotesDialog();
  backupPathDialog.classList.remove('hidden');
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  backupPathDialog.addEventListener('click', closeBackupPathDialogOnBlankClick);
}

// éšè—å¤‡ä»½è·¯å¾„å¯¹è¯æ¡†
function hideBackupPathDialog() {
  backupPathDialog.classList.add('hidden');
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  backupPathDialog.removeEventListener('click', closeBackupPathDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¤‡ä»½è·¯å¾„å¯¹è¯æ¡†
function closeBackupPathDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === backupPathDialog) {
    hideBackupPathDialog();
  }
}

// é€‰æ‹©å¤‡ä»½è·¯å¾„
async function chooseBackupPath() {
  try {
    const result = await ipcRenderer.invoke('choose-backup-path');
    if (result.success) {
      backupPathInput.value = result.path;
    }
  } catch (error) {
    console.error('é€‰æ‹©å¤‡ä»½è·¯å¾„å¤±è´¥:', error);
  }
}

// æ‰§è¡Œå¤‡ä»½æ“ä½œ
async function executeBackup() {
  const backupPath = backupPathInput.value.trim();
  
  if (!backupPath) {
    // ä½¿ç”¨ä¸è½¯ä»¶é£æ ¼ä¸€è‡´çš„æç¤º
    confirmMessage.textContent = 'è¯·é€‰æ‹©å¤‡ä»½è·¯å¾„';
    confirmDialog.classList.remove('hidden');
    confirmOkBtn.textContent = 'ç¡®å®š';
    confirmOkBtn.onclick = hideConfirmDialog;
    return;
  }
  
  try {
    // åˆ›å»ºå¤‡ä»½é…ç½®
    const backupConfig = {
      selectedNotes: selectedBackupNotes,
      backupPath: backupPath,
      autoSync: autoSyncToggle.checked
    };
    
    // æ‰§è¡Œå¤‡ä»½
    const result = await ipcRenderer.invoke('backup-notes', backupConfig);
    
    if (result.success) {
      // å¤‡ä»½æˆåŠŸåéšè—å¯¹è¯æ¡†
      hideBackupPathDialog();
      
      // æ˜¾ç¤ºå¤‡ä»½ç»“æœ
      const successCount = result.results.filter(r => r.success).length;
      const totalCount = result.results.length;
      
      // ä½¿ç”¨ç¡®è®¤å¯¹è¯æ¡†æ˜¾ç¤ºç»“æœ
      confirmMessage.textContent = `å¤‡ä»½å®Œæˆï¼š${successCount}/${totalCount} ä¸ªç¬”è®°å¤‡ä»½æˆåŠŸã€‚`;
      confirmDialog.classList.remove('hidden');
      confirmOkBtn.textContent = 'å…³é—­';
      confirmOkBtn.onclick = hideConfirmDialog;
    } else {
      // ä½¿ç”¨ä¸è½¯ä»¶é£æ ¼ä¸€è‡´çš„æç¤º
      confirmMessage.textContent = `å¤‡ä»½å¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}`;
      confirmDialog.classList.remove('hidden');
      confirmOkBtn.textContent = 'ç¡®å®š';
      confirmOkBtn.onclick = hideConfirmDialog;
    }
  } catch (error) {
    console.error('æ‰§è¡Œå¤‡ä»½å¤±è´¥:', error);
    // ä½¿ç”¨ä¸è½¯ä»¶é£æ ¼ä¸€è‡´çš„æç¤º
    confirmMessage.textContent = 'å¤‡ä»½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯';
    confirmDialog.classList.remove('hidden');
    confirmOkBtn.textContent = 'ç¡®å®š';
    confirmOkBtn.onclick = hideConfirmDialog;
  }
}

// åˆ‡æ¢è¡¨æƒ…åŒ…æç¤ºè®¾ç½®
async function toggleEmojiTips() {
  settings.emojiTips = emojiTipsToggle.checked;
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    
    // æ ¹æ®è®¾ç½®æ·»åŠ æˆ–ç§»é™¤ç‚¹å‡»äº‹ä»¶ç›‘å¬
    if (settings.emojiTips) {
      document.body.addEventListener('click', showRandomEmoji);
    } else {
      document.body.removeEventListener('click', showRandomEmoji);
      // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„è¡¨æƒ…åŒ…å…ƒç´ 
      document.querySelectorAll('.emoji-tip').forEach(emoji => {
        emoji.remove();
      });
    }
  } catch (error) {
    console.error('æ›´æ–°è¡¨æƒ…åŒ…æç¤ºè®¾ç½®å¤±è´¥:', error);
  }
}

// æ˜¾ç¤ºéšæœºè¡¨æƒ…åŒ…
function showRandomEmoji(event) {
  // è¡¨æƒ…åŒ…æ•°ç»„
  const emojis = [
    'ğŸ˜€', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜œ', 'ğŸ¤”', 'ğŸ˜´', 'ğŸ¥³', 'ğŸ˜‡', 'ğŸ¤—', 'ğŸ™„', 'ğŸ˜®', 'ğŸ¥º', 
    'ğŸ˜±', 'ğŸ¤¯', 'ğŸ¥´', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ™ƒ', 'ğŸ˜', 'ğŸ˜‹', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤¤',
    'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ¤¥', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ§ ', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ¤–', 'ğŸ’©', 'ğŸ‘¨â€ğŸ’»', 'ğŸ‘©â€ğŸ¨', 'ğŸ‘¨â€ğŸ”¬', 'ğŸ’†', 'ğŸ§˜', 'ğŸƒ',
    'ğŸ±', 'ğŸ¶', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¹', 'ğŸ­', 'ğŸ¦„', 'ğŸ´', 'ğŸ¦“',
    'ğŸŒˆ', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'ğŸ”¥', 'ğŸŒŠ', 'ğŸ€', 'ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¹', 'ğŸ„', 'ğŸ®', 'ğŸ¯', 'ğŸ²'
  ];
  
  // é¢œæ–‡å­—æ•°ç»„
  const kaomojis = [
    '(ï¼›Â´Ğ´ï½€)ã‚', '(â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»', '(ï¿£â–½ï¿£)ãƒ', '(Â´ï½¥Ï‰ï½¥`)', 'ãƒ½(Â°ã€‡Â°)ï¾‰',
    '(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§', '(ï½¡ï½¥Ï‰ï½¥ï½¡)', '(ã¤â‰§â–½â‰¦)ã¤', '(ï¾ŸĞ”ï¾Ÿ;)', '(Â´ï¼›Ï‰ï¼›`)',
    'ãƒ¾(â‰§â–½â‰¦*)o', '(â‰§âˆ‡â‰¦)/', '(ï¿£Îµï¿£)', '(ï¿£3ï¿£)', '(Â´ãƒ»Ï‰ãƒ»)ã£ç”±',
    'ãƒ½(âœ¿ï¾Ÿâ–½ï¾Ÿ)ãƒ', '(ãƒ_<ã€‚)', '(^_^;)', '(ï¼›ä¸€_ä¸€)', '(=^ï½¥Ï‰ï½¥^=)',
    '(â—•â€¿â—•)', '(/â‰§â–½â‰¦)/', '(ãƒ»âˆ€ãƒ»)', '(ã£Â´Ï‰`c)', '(*Â´âˆ€`*)',
    '(â•¥ï¹â•¥)', '(â‰§Ï‰â‰¦)', '(>_<)', '(ï½¡Â´âˆ€ï½€)ï¾‰', '(â—â€¢á´—â€¢â—)',
    'à² _à² ', 'à² â€¿à² ', '(Ë˜â–½Ë˜)', '(âŠ™_âŠ™)', '(âŠ™ËâŠ™)',
    '(ï½€ãƒ»Ï‰ãƒ»Â´)', '(*^â–½^*)', '(>Ï‰<)', '(^-^*)', '(â‰§âˆ€â‰¦)',
    'o(â‰§â–½â‰¦)o', 'â˜†*:.ï½¡.o(â‰§â–½â‰¦)o.ï½¡.:*â˜†', 'â„(â„â„â€¢â„Ï‰â„â€¢â„â„)â„', 'â•°(â–”âˆ€â–”)â•¯', '(ï¿£ãƒ˜ï¿£)',
    '(^â–½^)', '(â•¯ï¸µâ•°,)', '(///â‰§âˆ‡â‰¦///', '(ãƒÂ°Î¿Â°)ãƒ', '( Â´ï½¥Ï‰ï½¥)ï¾‰(._.`)'
  ];
  
  // éšæœºé€‰æ‹©æ˜¾ç¤ºè¡¨æƒ…åŒ…æˆ–é¢œæ–‡å­—
  const showEmoji = Math.random() > 0.5;
  
  // éšæœºé€‰æ‹©ä¸€ä¸ªè¡¨æƒ…åŒ…æˆ–é¢œæ–‡å­—
  const randomEmoji = showEmoji ? 
    emojis[Math.floor(Math.random() * emojis.length)] : 
    kaomojis[Math.floor(Math.random() * kaomojis.length)];
  
  // éšæœºä½ç½®ï¼ˆé¿å…å¤ªé è¿‘è¾¹ç¼˜ï¼‰
  const maxX = window.innerWidth - 100;
  const maxY = window.innerHeight - 50;
  const randomX = Math.floor(Math.random() * maxX);
  const randomY = Math.floor(Math.random() * maxY);
  
  // éšæœºé¢œè‰²
  const randomColor = `rgb(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)})`;
  
  // åˆ›å»ºè¡¨æƒ…åŒ…å…ƒç´ 
  const emojiElement = document.createElement('div');
  emojiElement.className = 'emoji-tip';
  emojiElement.textContent = randomEmoji;
  emojiElement.style.position = 'fixed';
  emojiElement.style.left = `${randomX}px`;
  emojiElement.style.top = `${randomY}px`;
  emojiElement.style.color = randomColor;
  emojiElement.style.fontSize = showEmoji ? '2rem' : '1.2rem';
  emojiElement.style.fontFamily = showEmoji ? 'inherit' : '"Microsoft YaHei", sans-serif';
  emojiElement.style.zIndex = '9999';
  emojiElement.style.pointerEvents = 'none'; // é˜²æ­¢è¡¨æƒ…åŒ…é˜»æŒ¡ç‚¹å‡»
  emojiElement.style.animation = 'fadeInOut 5s forwards';
  
  // æ·»åŠ åˆ°é¡µé¢
  document.body.appendChild(emojiElement);
  
  // 5ç§’åç§»é™¤
  setTimeout(() => {
    emojiElement.remove();
  }, 5000);
}

// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', initApp);

// ç«‹å³åˆ›å»ºèƒŒæ™¯å®¹å™¨ï¼Œä¸ç­‰å¾…DOMContentLoaded
(function() {
  // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³åˆ›å»ºèƒŒæ™¯å®¹å™¨
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMåŠ è½½å®Œæˆï¼Œç«‹å³åˆ›å»ºèƒŒæ™¯å®¹å™¨');
      createBackgroundContainer();
    });
  } else {
    // DOMå·²ç»åŠ è½½å®Œæˆ
    console.log('DOMå·²åŠ è½½ï¼Œç«‹å³åˆ›å»ºèƒŒæ™¯å®¹å™¨');
    createBackgroundContainer();
  }
})();

// é“¾æ¥ç®¡ç†ç›¸å…³å‡½æ•°
// æ˜¾ç¤ºé“¾æ¥ç®¡ç†å¯¹è¯æ¡†
function showLinksDialog() {
  renderLinksList();
  linksDialog.classList.remove('hidden');
  
  // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†
  linksDialog.addEventListener('click', closeLinksOnBlankClick);
}

// éšè—é“¾æ¥ç®¡ç†å¯¹è¯æ¡†
function hideLinksDialog() {
  linksDialog.classList.add('hidden');
  
  // ç§»é™¤ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
  linksDialog.removeEventListener('click', closeLinksOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­é“¾æ¥ç®¡ç†å¯¹è¯æ¡†
function closeLinksOnBlankClick(event) {
  if (event.target === linksDialog) {
    hideLinksDialog();
  }
}

// æ¸²æŸ“é“¾æ¥åˆ—è¡¨
function renderLinksList() {
  linksList.innerHTML = '';
  
  if (!settings.links || settings.links.length === 0) {
    linksList.innerHTML = '<div class="empty-state">æš‚æ— é“¾æ¥ï¼Œç‚¹å‡»"æ·»åŠ é“¾æ¥"æŒ‰é’®åˆ›å»º</div>';
    return;
  }
  
  settings.links.forEach(link => {
    const linkItem = document.createElement('div');
    linkItem.className = 'link-item';
    
    // å›¾æ ‡éƒ¨åˆ†
    const iconHtml = link.iconType === 'image' 
      ? `<img src="${link.iconValue}" alt="${link.name}">`
      : link.iconValue;
    
    linkItem.innerHTML = `
      <div class="link-icon">${iconHtml}</div>
      <div class="link-info">
        <div class="link-name">${escapeHtml(link.name)}</div>
        <div class="link-url">${escapeHtml(link.url)}</div>
      </div>
      <div class="link-actions">
        <button class="link-action-btn link-edit-btn" title="ç¼–è¾‘" data-id="${link.id}">âœï¸</button>
        <button class="link-action-btn link-delete-btn" title="åˆ é™¤" data-id="${link.id}">ğŸ—‘ï¸</button>
      </div>
    `;
    
    // æ·»åŠ ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
    const editBtn = linkItem.querySelector('.link-edit-btn');
    const deleteBtn = linkItem.querySelector('.link-delete-btn');
    
    editBtn.addEventListener('click', () => {
      showEditLinkDialog(link.id);
    });
    
    deleteBtn.addEventListener('click', () => {
      showDeleteLinkConfirm(link.id);
    });
    
    linksList.appendChild(linkItem);
  });
}

// æ¸²æŸ“é“¾æ¥æ˜¾ç¤ºåŒº
function renderLinksDisplay() {
  linksDisplay.innerHTML = '';
  
  if (!settings.links || settings.links.length === 0) {
    linksDisplay.classList.add('hidden');
    if (linksRightTrigger) {
      linksRightTrigger.classList.add('hidden');
    }
    return;
  }
  
  // æ¸…ç©ºä¹‹å‰çš„æ ·å¼ç±»
  linksDisplay.className = 'links-display';
  
  // åº”ç”¨å½“å‰çš„é“¾æ¥æ˜¾ç¤ºä½ç½®
  if (settings.linksDisplayPosition === 'right') {
    linksDisplay.classList.add('right-side');
    if (linksRightTrigger) {
      linksRightTrigger.classList.remove('hidden');
    }
    // å³ä¾§æ¨¡å¼æ—¶ï¼Œæ”¾å›åŸä½ç½®
    if (linksDisplay.parentElement !== notesListContainer) {
      notesListContainer.insertBefore(linksDisplay, notesList);
    }
  } else if (settings.linksDisplayPosition === 'bottom') {
    linksDisplay.classList.add('bottom-side');
    if (linksRightTrigger) {
      linksRightTrigger.classList.add('hidden');
    }
    
    // åº•éƒ¨æ¨¡å¼æ—¶ï¼Œç¡®ä¿é“¾æ¥æ˜¾ç¤ºåŒºåœ¨bodyä¸­
    if (linksDisplay.parentElement !== document.body) {
      // å°†é“¾æ¥æ˜¾ç¤ºåŒºç§»åŠ¨åˆ°bodyæœ«å°¾
      document.body.appendChild(linksDisplay);
    }
  } else {
    // é»˜è®¤ä½ç½®
    if (linksRightTrigger) {
      linksRightTrigger.classList.add('hidden');
    }
    
    // é»˜è®¤æ¨¡å¼æ—¶ï¼Œæ”¾å›åŸä½ç½®
    if (linksDisplay.parentElement !== notesListContainer) {
      notesListContainer.insertBefore(linksDisplay, notesList);
    }
  }
  
  settings.links.forEach(link => {
    const linkShortcut = document.createElement('div');
    linkShortcut.className = 'link-shortcut';
    linkShortcut.title = link.url;
    
    // å›¾æ ‡éƒ¨åˆ†
    const iconHtml = link.iconType === 'image' 
      ? `<img src="${link.iconValue}" alt="${link.name}">`
      : link.iconValue;
    
    linkShortcut.innerHTML = `
      <div class="link-shortcut-icon">${iconHtml}</div>
      <div class="link-shortcut-name">${escapeHtml(link.name)}</div>
    `;
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    linkShortcut.addEventListener('click', () => {
      openExternalLink(link.url);
    });
    
    linksDisplay.appendChild(linkShortcut);
  });
  
  linksDisplay.classList.remove('hidden');
}

// æ‰“å¼€å¤–éƒ¨é“¾æ¥
function openExternalLink(url) {
  ipcRenderer.invoke('open-external-link', url);
}

// æ˜¾ç¤ºæ·»åŠ é“¾æ¥å¯¹è¯æ¡†
function showAddLinkDialog() {
  editLinkTitle.textContent = 'æ·»åŠ é“¾æ¥';
  currentEditingLinkId = null;
  linkNameInput.value = '';
  linkUrlInput.value = '';
  
  // é‡ç½®å›¾æ ‡é€‰æ‹©
  selectedIconType = 'emoji';
  selectedIconValue = 'ğŸ”—';
  updateIconPreview();
  
  // éšè—è¡¨æƒ…é€‰æ‹©å™¨
  emojiPicker.classList.add('hidden');
  
  editLinkDialog.classList.remove('hidden');
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  editLinkDialog.addEventListener('click', closeEditLinkDialogOnBlankClick);
}

// æ˜¾ç¤ºç¼–è¾‘é“¾æ¥å¯¹è¯æ¡†
function showEditLinkDialog(linkId) {
  const link = settings.links.find(l => l.id === linkId);
  if (!link) return;
  
  editLinkTitle.textContent = 'ç¼–è¾‘é“¾æ¥';
  currentEditingLinkId = linkId;
  linkNameInput.value = link.name;
  linkUrlInput.value = link.url;
  
  // è®¾ç½®å½“å‰å›¾æ ‡
  selectedIconType = link.iconType;
  selectedIconValue = link.iconValue;
  updateIconPreview();
  
  // éšè—è¡¨æƒ…é€‰æ‹©å™¨
  emojiPicker.classList.add('hidden');
  
  editLinkDialog.classList.remove('hidden');
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  editLinkDialog.addEventListener('click', closeEditLinkDialogOnBlankClick);
}

// éšè—ç¼–è¾‘é“¾æ¥å¯¹è¯æ¡†
function hideEditLinkDialog() {
  editLinkDialog.classList.add('hidden');
  currentEditingLinkId = null;
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  editLinkDialog.removeEventListener('click', closeEditLinkDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­ç¼–è¾‘é“¾æ¥å¯¹è¯æ¡†
function closeEditLinkDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === editLinkDialog) {
    hideEditLinkDialog();
  }
}

// æ›´æ–°å›¾æ ‡é¢„è§ˆ
function updateIconPreview() {
  if (selectedIconType === 'image') {
    iconPreview.innerHTML = `<img src="${selectedIconValue}" alt="å›¾æ ‡">`;
  } else {
    iconPreview.innerHTML = `<i class="default-icon">${selectedIconValue}</i>`;
  }
}

// åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨
function toggleEmojiPicker() {
  if (emojiPicker.classList.contains('hidden')) {
    // æ˜¾ç¤ºè¡¨æƒ…é€‰æ‹©å™¨
    emojiPicker.classList.remove('hidden');
    
    // ç”Ÿæˆè¡¨æƒ…åˆ—è¡¨
    const emojiContainer = emojiPicker.querySelector('.emoji-container');
    emojiContainer.innerHTML = '';
    
    // å¸¸ç”¨è¡¨æƒ…åˆ—è¡¨
    const emojis = [
      // å¸¸ç”¨ç¬¦å·å’Œå·¥å…·
      'ğŸ”—', 'ğŸŒ', 'ğŸ“', 'ğŸ“š', 'ğŸ“°', 'ğŸ”', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“Œ', 'ğŸ“', 'ğŸ”–',
      'ğŸ“', 'ğŸ“‚', 'ğŸ“„', 'ğŸ“ƒ', 'ğŸ“‘', 'ğŸ”’', 'ğŸ”“', 'ğŸ”', 'ğŸ”', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸ“±',
      'ğŸ’»', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ“·', 'ğŸ¥', 'ğŸ¬', 'ğŸ“º', 'ğŸ“»',
      
      // å¨±ä¹å’Œæ¸¸æˆ
      'ğŸ“¼', 'ğŸ“€', 'ğŸ’¿', 'ğŸ’¾', 'ğŸ’½', 'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ²', 'â™Ÿï¸', 'ğŸ¯', 'ğŸ±', 'ğŸ­',
      'ğŸ¨', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸ¥', 'ğŸ·', 'ğŸº', 'ğŸ¸', 'ğŸ»', 'ğŸ¬', 'ğŸ®',
      
      // è¡¨æƒ…
      'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ',
      'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ',
      'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ',
      
      // åŠ¨ç‰©å’Œè‡ªç„¶
      'ğŸ±', 'ğŸ¶', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¹',
      'ğŸ­', 'ğŸ¦„', 'ğŸ´', 'ğŸ¦“', 'ğŸ¦’', 'ğŸ˜', 'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦™', 'ğŸ¦˜', 'ğŸ¦¥',
      
      // è‡ªç„¶å’Œå¤©æ°”
      'ğŸŒˆ', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¥ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸',
      'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒ¬ï¸', 'ğŸ’¨', 'ğŸŒªï¸', 'ğŸŒ«ï¸', 'ğŸŒŠ', 'ğŸ’¦',
      
      // é£Ÿç‰©å’Œé¥®æ–™
      'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­',
      'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ¥‘', 'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸŒ¶ï¸', 'ğŸ¥’', 'ğŸ¥¬'
    ];
    
    emojis.forEach(emoji => {
      const emojiItem = document.createElement('div');
      emojiItem.className = 'emoji-item';
      emojiItem.textContent = emoji;
      
      emojiItem.addEventListener('click', () => {
        selectedIconType = 'emoji';
        selectedIconValue = emoji;
        updateIconPreview();
        emojiPicker.classList.add('hidden');
      });
      
      emojiContainer.appendChild(emojiItem);
    });
  } else {
    // éšè—è¡¨æƒ…é€‰æ‹©å™¨
    emojiPicker.classList.add('hidden');
  }
}

// é€‰æ‹©å›¾æ ‡å›¾ç‰‡
async function chooseIconImage() {
  try {
    const result = await ipcRenderer.invoke('choose-icon-image');
    if (result.success) {
      selectedIconType = 'image';
      selectedIconValue = result.path;
      updateIconPreview();
    }
  } catch (error) {
    console.error('é€‰æ‹©å›¾æ ‡å›¾ç‰‡å¤±è´¥:', error);
  }
}

// ä¿å­˜é“¾æ¥
async function saveLink() {
  const name = linkNameInput.value.trim();
  const url = linkUrlInput.value.trim();
  
  if (!name || !url) {
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    confirmMessage.textContent = 'è¯·è¾“å…¥é“¾æ¥åç§°å’ŒURL';
    confirmDialog.classList.remove('hidden');
    confirmOkBtn.onclick = hideConfirmDialog;
    return;
  }
  
  // éªŒè¯URLæ ¼å¼
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    confirmMessage.textContent = 'URLå¿…é¡»ä»¥http://æˆ–https://å¼€å¤´';
    confirmDialog.classList.remove('hidden');
    confirmOkBtn.onclick = hideConfirmDialog;
    return;
  }
  
  try {
    if (currentEditingLinkId) {
      // ç¼–è¾‘ç°æœ‰é“¾æ¥
      const linkIndex = settings.links.findIndex(l => l.id === currentEditingLinkId);
      if (linkIndex !== -1) {
        settings.links[linkIndex] = {
          ...settings.links[linkIndex],
          name,
          url,
          iconType: selectedIconType,
          iconValue: selectedIconValue,
          updated: Date.now()
        };
      }
    } else {
      // æ·»åŠ æ–°é“¾æ¥
      const newLink = {
        id: generateUUID(),
        name,
        url,
        iconType: selectedIconType,
        iconValue: selectedIconValue,
        created: Date.now()
      };
      
      if (!settings.links) {
        settings.links = [];
      }
      
      settings.links.push(newLink);
    }
    
    // ä¿å­˜è®¾ç½®
    await ipcRenderer.invoke('update-settings', settings);
    
    // æ›´æ–°é“¾æ¥åˆ—è¡¨å’Œæ˜¾ç¤ºåŒº
    renderLinksList();
    renderLinksDisplay();
    
    // éšè—å¯¹è¯æ¡†
    hideEditLinkDialog();
  } catch (error) {
    console.error('ä¿å­˜é“¾æ¥å¤±è´¥:', error);
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    confirmMessage.textContent = 'ä¿å­˜é“¾æ¥å¤±è´¥';
    confirmDialog.classList.remove('hidden');
    confirmOkBtn.onclick = hideConfirmDialog;
  }
}

// æ˜¾ç¤ºåˆ é™¤é“¾æ¥ç¡®è®¤å¯¹è¯æ¡†
function showDeleteLinkConfirm(linkId) {
  const link = settings.links.find(l => l.id === linkId);
  if (!link) return;
  
  confirmMessage.textContent = `ç¡®å®šè¦åˆ é™¤é“¾æ¥"${link.name}"å—ï¼Ÿ`;
  confirmDialog.classList.remove('hidden');
  
  confirmOkBtn.onclick = async () => {
    try {
      // åˆ é™¤é“¾æ¥
      settings.links = settings.links.filter(l => l.id !== linkId);
      
      // ä¿å­˜è®¾ç½®
      await ipcRenderer.invoke('update-settings', settings);
      
      // æ›´æ–°é“¾æ¥åˆ—è¡¨å’Œæ˜¾ç¤ºåŒº
      renderLinksList();
      renderLinksDisplay();
      
      hideConfirmDialog();
    } catch (error) {
      console.error('åˆ é™¤é“¾æ¥å¤±è´¥:', error);
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      confirmMessage.textContent = 'åˆ é™¤é“¾æ¥å¤±è´¥';
      confirmDialog.classList.remove('hidden');
      confirmOkBtn.onclick = hideConfirmDialog;
    }
  };
  
  confirmCancelBtn.onclick = hideConfirmDialog;
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  confirmDialog.addEventListener('click', closeConfirmDialogOnBlankClick);
}

// åº”ç”¨æŒ‰é’®ä½ç½®
function applyButtonPosition(position) {
  if (buttonContainer) {
    // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ä½ç½®ç±»
    buttonContainer.classList.remove('buttons-left', 'buttons-center', 'buttons-right');
    
    // æ·»åŠ å¯¹åº”çš„ä½ç½®ç±»
    buttonContainer.classList.add(`buttons-${position}`);
  }
}

// åˆ‡æ¢æŒ‰é’®ä½ç½®
async function toggleButtonPosition(position) {
  settings.buttonPosition = position;
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    applyButtonPosition(position);
  } catch (error) {
    console.error('æ›´æ–°æŒ‰é’®ä½ç½®è®¾ç½®å¤±è´¥:', error);
  }
}

// æ˜¾ç¤ºåˆ†äº«å¯¹è¯æ¡†
function showShareDialog() {
  if (!currentNoteId) return;
  shareDialog.classList.remove('hidden');
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  shareDialog.addEventListener('click', closeShareDialogOnBlankClick);
}

// éšè—åˆ†äº«å¯¹è¯æ¡†
function hideShareDialog() {
  shareDialog.classList.add('hidden');
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  shareDialog.removeEventListener('click', closeShareDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­åˆ†äº«å¯¹è¯æ¡†
function closeShareDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === shareDialog) {
    hideShareDialog();
  }
}

// å¤„ç†åˆ†äº«é€‰é¡¹ç‚¹å‡»
async function handleShareOption(event) {
  const option = event.currentTarget;
  const format = option.dataset.format;
  
  if (!currentNoteId || !format) return;
  
  try {
    const note = await ipcRenderer.invoke('get-note', currentNoteId);
    if (!note) return;
    
    // æ ¹æ®é€‰æ‹©çš„æ ¼å¼å¤„ç†å†…å®¹
    let content = '';
    let fileType = '';
    let fileName = '';
    
    switch (format) {
      case 'text':
        // æå–çº¯æ–‡æœ¬
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = note.content;
        content = `${note.title}\n\n${tempDiv.textContent || tempDiv.innerText || ''}`;
        fileType = 'text/plain';
        fileName = `${note.title.replace(/[\\/:*?"<>|]/g, '_')}.txt`;
        break;
        
      case 'html':
        // å¯¼å‡ºHTMLæ ¼å¼
        content = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${escapeHtml(note.title)}</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
    h1 { color: #4a69bd; }
  </style>
</head>
<body>
  <h1>${escapeHtml(note.title)}</h1>
  <div>${note.content}</div>
</body>
</html>`;
        fileType = 'text/html';
        fileName = `${note.title.replace(/[\\/:*?"<>|]/g, '_')}.html`;
        break;
        
      case 'markdown':
        // å¯¼å‡ºMarkdownæ ¼å¼
        const htmlToMarkdown = (html) => {
          // ç®€å•çš„HTMLåˆ°Markdownè½¬æ¢
          let md = html.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
                      .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
                      .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
                      .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n')
                      .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n')
                      .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n')
                      .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
                      .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
                      .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
                      .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
                      .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
                      .replace(/<a href="(.*?)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)')
                      .replace(/<ul[^>]*>(.*?)<\/ul>/gi, '$1\n')
                      .replace(/<ol[^>]*>(.*?)<\/ol>/gi, '$1\n')
                      .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
                      .replace(/<br[^>]*>/gi, '\n')
                      .replace(/<img src="(.*?)"[^>]*>/gi, '![]($1)')
                      .replace(/<hr[^>]*>/gi, '---\n\n');
          
          // ç§»é™¤æ‰€æœ‰å‰©ä½™çš„HTMLæ ‡ç­¾
          md = md.replace(/<[^>]*>/g, '');
          
          // æ¸…ç†å¤šä½™çš„æ¢è¡Œ
          md = md.replace(/\n\s*\n\s*\n/g, '\n\n');
          
          return md;
        };
        
        content = `# ${note.title}\n\n${htmlToMarkdown(note.content)}`;
        fileType = 'text/markdown';
        fileName = `${note.title.replace(/[\\/:*?"<>|]/g, '_')}.md`;
        break;
        
      case 'image':
        // å¯¼å‡ºä¸ºå›¾ç‰‡éœ€è¦ä½¿ç”¨ä¸»è¿›ç¨‹çš„åŠŸèƒ½
        ipcRenderer.invoke('export-note-as-image', currentNoteId)
          .then(result => {
            if (result.success) {
              // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
              showToast('ç¬”è®°å·²å¯¼å‡ºä¸ºå›¾ç‰‡');
            } else {
              showToast('å¯¼å‡ºå›¾ç‰‡å¤±è´¥: ' + result.error);
            }
          })
          .catch(error => {
            console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥:', error);
            showToast('å¯¼å‡ºå›¾ç‰‡å¤±è´¥');
          });
        hideShareDialog();
        return;
        
      case 'app':
        // è‡ªå®šä¹‰åº”ç”¨åˆ†äº«
        handleCustomAppShare(note);
        hideShareDialog();
        return;
        
      case 'email':
        // é‚®ä»¶åˆ†äº«
        showEmailShareDialog(note);
        hideShareDialog();
        return;
    }
    
    // ä½¿ç”¨Electronçš„ä¿å­˜å¯¹è¯æ¡†
    const result = await ipcRenderer.invoke('save-shared-note', {
      content,
      fileType,
      fileName
    });
    
    if (result.success) {
      showToast('ç¬”è®°å·²ä¿å­˜åˆ°: ' + result.filePath);
    } else {
      showToast('ä¿å­˜ç¬”è®°å¤±è´¥');
    }
  } catch (error) {
    console.error('åˆ†äº«ç¬”è®°å¤±è´¥:', error);
    showToast('åˆ†äº«ç¬”è®°å¤±è´¥');
  }
  
  hideShareDialog();
}

// å¤„ç†è‡ªå®šä¹‰åº”ç”¨åˆ†äº«
async function handleCustomAppShare(note) {
  try {
    // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    const tempFile = await createTempFileForSharing(note);
    if (!tempFile) {
      showToast('å‡†å¤‡åˆ†äº«å†…å®¹å¤±è´¥');
      return;
    }

    // æ˜¾ç¤ºè‡ªå®šä¹‰åº”ç”¨é€‰æ‹©å¯¹è¯æ¡†
    showAppSelectDialog(tempFile);
  } catch (error) {
    console.error('è‡ªå®šä¹‰åº”ç”¨åˆ†äº«å¤±è´¥:', error);
    showToast('åˆ†äº«å¤±è´¥');
  }
}

// æ˜¾ç¤ºåº”ç”¨é€‰æ‹©å¯¹è¯æ¡†
async function showAppSelectDialog(filePath) {
  try {
    // æ¸…ç©ºå®¹å™¨
    socialAppsContainer.innerHTML = '';
    otherAppsContainer.innerHTML = '';
    
    // ä¿å­˜æ–‡ä»¶è·¯å¾„åˆ°å¯¹è¯æ¡†æ•°æ®å±æ€§
    appSelectDialog.dataset.filePath = filePath;
    
    // å®šä¹‰ç¤¾äº¤åº”ç”¨
    const socialApps = [
      { name: 'å¾®ä¿¡', icon: 'ğŸ“±', id: 'WeChat' },
      { name: 'QQ', icon: 'ğŸ’¬', id: 'QQ' },
      { name: 'å¾®åš', icon: 'ğŸ”„', id: 'Weibo' },
      { name: 'é’‰é’‰', icon: 'ğŸ“Œ', id: 'DingTalk' },
      { name: 'ä¼ä¸šå¾®ä¿¡', icon: 'ğŸ¢', id: 'WeCom' },
      { name: 'é£ä¹¦', icon: 'âœˆï¸', id: 'Feishu' },
      { name: 'å’Œé£ä¿¡', icon: 'ğŸ“¨', id: 'Fetion' },
      { name: 'è…¾è®¯ä¼šè®®', icon: 'ğŸ‘¥', id: 'TencentMeeting' }
    ];
    
    // å®šä¹‰å…¶ä»–å¸¸ç”¨åº”ç”¨
    const otherApps = [
      { name: 'è®°äº‹æœ¬', icon: 'ğŸ“', id: 'Notepad' },
      { name: 'Word', icon: 'ğŸ“„', id: 'Word' },
      { name: 'Excel', icon: 'ğŸ“Š', id: 'Excel' },
      { name: 'Chrome', icon: 'ğŸŒ', id: 'Chrome' },
      { name: 'Edge', icon: 'ğŸ”', id: 'Edge' },
      { name: 'é‚®ä»¶', icon: 'ğŸ“§', id: 'Mail' },
      { name: 'ç”»å›¾', icon: 'ğŸ¨', id: 'Paint' },
      { name: 'OneNote', icon: 'ğŸ“’', id: 'OneNote' }
    ];
    
    // æ¸²æŸ“ç¤¾äº¤åº”ç”¨
    socialApps.forEach(app => {
      const appItem = createAppItem(app);
      socialAppsContainer.appendChild(appItem);
    });
    
    // æ¸²æŸ“å…¶ä»–åº”ç”¨
    otherApps.forEach(app => {
      const appItem = createAppItem(app);
      otherAppsContainer.appendChild(appItem);
    });
    
    // æ˜¾ç¤ºå¯¹è¯æ¡†
    appSelectDialog.classList.remove('hidden');
    
    // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
    appSelectDialog.addEventListener('click', closeAppSelectDialogOnBlankClick);
  } catch (error) {
    console.error('æ˜¾ç¤ºåº”ç”¨é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥:', error);
    showToast('æ— æ³•æ˜¾ç¤ºåº”ç”¨åˆ—è¡¨');
  }
}

// åˆ›å»ºåº”ç”¨é¡¹
function createAppItem(app) {
  const appItem = document.createElement('div');
  appItem.className = 'app-item';
  appItem.dataset.id = app.id;
  
  const appIcon = document.createElement('div');
  appIcon.className = 'app-icon';
  if (app.icon.startsWith('http')) {
    const img = document.createElement('img');
    img.src = app.icon;
    img.alt = app.name;
    appIcon.appendChild(img);
  } else {
    appIcon.textContent = app.icon;
  }
  
  const appName = document.createElement('div');
  appName.className = 'app-name';
  appName.textContent = app.name;
  
  appItem.appendChild(appIcon);
  appItem.appendChild(appName);
  
  // æ·»åŠ ç‚¹å‡»äº‹ä»¶
  appItem.addEventListener('click', function() {
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„é“¾æ¥
    const savedLink = getSavedAppLink(app.id);
    
    if (savedLink) {
      // å¦‚æœæœ‰ä¿å­˜çš„é“¾æ¥ï¼Œç›´æ¥ä½¿ç”¨
      openWithApp(app.id, app.name, savedLink);
    } else {
      // å¦åˆ™æ˜¾ç¤ºé“¾æ¥è¾“å…¥å¯¹è¯æ¡†
      showWebLinkDialog(app);
    }
  });
  
  return appItem;
}

// è·å–ä¿å­˜çš„åº”ç”¨é“¾æ¥
function getSavedAppLink(appId) {
  if (!settings.appLinks) return null;
  
  const appLink = settings.appLinks.find(link => link.appId === appId);
  return appLink ? appLink.url : null;
}

// æ˜¾ç¤ºç½‘ç«™é“¾æ¥å¯¹è¯æ¡†
function showWebLinkDialog(app) {
  selectedAppForLink = app;
  webLinkTitle.textContent = `ä¸º ${app.name} é€‰æ‹©ç›®æ ‡ç½‘å€`;
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„é“¾æ¥
  const savedLink = getSavedAppLink(app.id);
  if (savedLink) {
    webLinkInput.value = savedLink;
    rememberLinkToggle.checked = true;
  } else {
    webLinkInput.value = '';
    rememberLinkToggle.checked = false;
  }
  
  webLinkDialog.classList.remove('hidden');
  webLinkInput.focus();
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  webLinkDialog.addEventListener('click', closeWebLinkDialogOnBlankClick);
}

// éšè—ç½‘ç«™é“¾æ¥å¯¹è¯æ¡†
function hideWebLinkDialog() {
  webLinkDialog.classList.add('hidden');
  selectedAppForLink = null;
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  webLinkDialog.removeEventListener('click', closeWebLinkDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­ç½‘ç«™é“¾æ¥å¯¹è¯æ¡†
function closeWebLinkDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === webLinkDialog) {
    hideWebLinkDialog();
  }
}

// ç¡®è®¤ç½‘ç«™é“¾æ¥
async function confirmWebLink() {
  if (!selectedAppForLink) return;
  
  const link = webLinkInput.value.trim();
  if (!link) {
    showToast('è¯·è¾“å…¥ç½‘ç«™é“¾æ¥');
    return;
  }
  
  // éªŒè¯é“¾æ¥æ ¼å¼
  if (!link.startsWith('http://') && !link.startsWith('https://')) {
    showToast('é“¾æ¥å¿…é¡»ä»¥http://æˆ–https://å¼€å¤´');
    return;
  }
  
  // å¦‚æœé€‰æ‹©äº†è®°ä½é“¾æ¥ï¼Œä¿å­˜è®¾ç½®
  if (rememberLinkToggle.checked) {
    await saveAppLink(selectedAppForLink.id, link);
  }
  
  // æ‰“å¼€åº”ç”¨å¹¶ä¼ é€’é“¾æ¥
  const filePath = appSelectDialog.dataset.filePath;
  if (filePath) {
    openWithApp(selectedAppForLink.id, selectedAppForLink.name, link);
  }
  
  hideWebLinkDialog();
}

// ä¿å­˜åº”ç”¨é“¾æ¥è®¾ç½®
async function saveAppLink(appId, url) {
  if (!settings.appLinks) {
    settings.appLinks = [];
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  const existingIndex = settings.appLinks.findIndex(link => link.appId === appId);
  
  if (existingIndex !== -1) {
    // æ›´æ–°ç°æœ‰é“¾æ¥
    settings.appLinks[existingIndex].url = url;
  } else {
    // æ·»åŠ æ–°é“¾æ¥
    settings.appLinks.push({
      appId: appId,
      url: url,
      timestamp: Date.now()
    });
  }
  
  // ä¿å­˜è®¾ç½®
  try {
    await ipcRenderer.invoke('update-settings', settings);
    console.log('åº”ç”¨é“¾æ¥è®¾ç½®å·²ä¿å­˜');
  } catch (error) {
    console.error('ä¿å­˜åº”ç”¨é“¾æ¥è®¾ç½®å¤±è´¥:', error);
  }
}

// ä½¿ç”¨æŒ‡å®šåº”ç”¨æ‰“å¼€æ–‡ä»¶
async function openWithApp(appId, appName, webLink = null) {
  const filePath = appSelectDialog.dataset.filePath;
  if (!filePath) {
    showToast('æ²¡æœ‰å¯åˆ†äº«çš„å†…å®¹');
    hideAppSelectDialog();
    return;
  }
  
  try {
    // å‘ä¸»è¿›ç¨‹å‘é€è¯·æ±‚ï¼Œå°è¯•ä½¿ç”¨æŒ‡å®šåº”ç”¨æ‰“å¼€æ–‡ä»¶
    const result = await ipcRenderer.invoke('share-with-app', {
      appPath: appId, // åº”ç”¨ID/è·¯å¾„
      filePath: filePath,
      webLink: webLink // æ·»åŠ ç½‘ç«™é“¾æ¥å‚æ•°
    });
    
    if (result.success) {
      showToast(`å·²å°è¯•ä½¿ç”¨ ${appName} æ‰“å¼€`);
    } else {
      showToast('æ‰“å¼€å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
    }
    
    hideAppSelectDialog();
  } catch (error) {
    console.error('ä½¿ç”¨åº”ç”¨æ‰“å¼€æ–‡ä»¶å¤±è´¥:', error);
    showToast('æ‰“å¼€å¤±è´¥');
    hideAppSelectDialog();
  }
}

// æ˜¾ç¤ºæ ‡é¢˜é¢œè‰²å¯¹è¯æ¡†
function showTitleColorDialog() {
  if (!currentNoteId) return;
  
  // åˆå§‹åŒ–å¯¹è¯æ¡†ï¼Œè®¾ç½®å½“å‰æ ‡é¢˜é¢œè‰²
  const noteTitleElement = document.getElementById('note-title-display');
  const currentColor = noteTitleElement.style.color || getComputedStyle(noteTitleElement).color;
  
  // å°è¯•è½¬æ¢å½“å‰é¢œè‰²ä¸ºåå…­è¿›åˆ¶
  selectedTitleColor = rgbToHex(currentColor) || '#4a69bd';
  customTitleColor.value = selectedTitleColor;
  
  // æ¸…é™¤æ‰€æœ‰é¢„è®¾é¢œè‰²çš„é€‰ä¸­çŠ¶æ€
  titleColorOptions.forEach(option => {
    option.classList.remove('selected');
    // æ‰¾åˆ°åŒ¹é…çš„é¢„è®¾é¢œè‰²å¹¶é€‰ä¸­
    if (option.dataset.color.toLowerCase() === selectedTitleColor.toLowerCase()) {
      option.classList.add('selected');
    }
  });
  
  // è·å–å½“å‰ç¬”è®°èƒŒæ™¯é¢œè‰²
  const noteItem = document.querySelector(`.note-item[data-id="${currentNoteId}"]`);
  if (noteItem) {
    const currentBgColor = noteItem.style.backgroundColor || '#f5f5f5';
    selectedBgColor = rgbToHex(currentBgColor) || '#f5f5f5';
    customBgColor.value = selectedBgColor;
    
    // æ¸…é™¤æ‰€æœ‰é¢„è®¾èƒŒæ™¯é¢œè‰²çš„é€‰ä¸­çŠ¶æ€å¹¶è®¾ç½®å½“å‰é€‰ä¸­çš„èƒŒæ™¯é¢œè‰²
    bgColorOptions.forEach(option => {
      option.classList.remove('selected');
      if (option.dataset.color.toLowerCase() === selectedBgColor.toLowerCase()) {
        option.classList.add('selected');
      }
    });
  }
  
  titleColorDialog.classList.remove('hidden');
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  titleColorDialog.addEventListener('click', closeTitleColorDialogOnBlankClick);
}

// éšè—æ ‡é¢˜é¢œè‰²å¯¹è¯æ¡†
function hideTitleColorDialog() {
  titleColorDialog.classList.add('hidden');
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  titleColorDialog.removeEventListener('click', closeTitleColorDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ ‡é¢˜é¢œè‰²å¯¹è¯æ¡†
function closeTitleColorDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === titleColorDialog) {
    hideTitleColorDialog();
  }
}

// åº”ç”¨æ ‡é¢˜é¢œè‰²
async function applyTitleColor() {
  if (!currentNoteId || (!selectedTitleColor && !selectedBgColor)) {
    hideTitleColorDialog();
    return;
  }
  
  try {
    // è·å–ç¬”è®°æ•°æ®
    const note = await ipcRenderer.invoke('get-note', currentNoteId);
    if (!note) return;
    
    // æ›´æ–°æ ‡é¢˜é¢œè‰²
    const noteTitleElement = document.getElementById('note-title-display');
    noteTitleElement.style.color = selectedTitleColor;
    
    // æ›´æ–°ç¬”è®°åˆ—è¡¨ä¸­å¯¹åº”é¡¹çš„èƒŒæ™¯é¢œè‰²
    const noteItem = document.querySelector(`.note-item[data-id="${currentNoteId}"]`);
    if (noteItem && selectedBgColor) {
      noteItem.style.backgroundColor = selectedBgColor;
      noteItem.classList.add('custom-bg');
    }
    
    // ä¿å­˜é¢œè‰²è®¾ç½®åˆ°ç¬”è®°
    if (!note.metadata) note.metadata = {};
    note.metadata.titleColor = selectedTitleColor;
    note.metadata.bgColor = selectedBgColor;
    
    // é€šçŸ¥ä¸»è¿›ç¨‹æ›´æ–°ç¬”è®°å…ƒæ•°æ®
    await ipcRenderer.invoke('update-note-metadata', currentNoteId, note.metadata);
    
    hideTitleColorDialog();
  } catch (error) {
    console.error('åº”ç”¨é¢œè‰²è®¾ç½®å¤±è´¥:', error);
    showToast('è®¾ç½®é¢œè‰²å¤±è´¥');
  }
}

// RGBé¢œè‰²è½¬æ¢ä¸ºåå…­è¿›åˆ¶
function rgbToHex(rgb) {
  // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯åå…­è¿›åˆ¶
  if (rgb.startsWith('#')) return rgb;
  
  // æå–RGBå€¼
  const rgbMatch = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
  if (!rgbMatch) return null;
  
  const r = parseInt(rgbMatch[1], 10);
  const g = parseInt(rgbMatch[2], 10);
  const b = parseInt(rgbMatch[3], 10);
  
  return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

// æ‰“å¼€ç³»ç»Ÿåº”ç”¨é€‰æ‹©å™¨
async function openSystemAppPicker() {
  const filePath = appSelectDialog.dataset.filePath;
  if (!filePath) {
    showToast('æ²¡æœ‰å¯åˆ†äº«çš„å†…å®¹');
    hideAppSelectDialog();
    return;
  }
  
  try {
    // ä½¿ç”¨ç³»ç»Ÿçš„"æ‰“å¼€æ–¹å¼"å¯¹è¯æ¡†
    await ipcRenderer.invoke('open-with-dialog', filePath);
    hideAppSelectDialog();
  } catch (error) {
    console.error('æ‰“å¼€ç³»ç»Ÿåº”ç”¨é€‰æ‹©å™¨å¤±è´¥:', error);
    showToast('æ‰“å¼€å¤±è´¥');
  }
}

// éšè—åº”ç”¨é€‰æ‹©å¯¹è¯æ¡†
function hideAppSelectDialog() {
  appSelectDialog.classList.add('hidden');
  delete appSelectDialog.dataset.filePath;
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  appSelectDialog.removeEventListener('click', closeAppSelectDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­åº”ç”¨é€‰æ‹©å¯¹è¯æ¡†
function closeAppSelectDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === appSelectDialog) {
    hideAppSelectDialog();
  }
}

// æ˜¾ç¤ºç®€å•çš„æç¤ºæ¶ˆæ¯
function showToast(message, duration = 3000) {
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨toastå…ƒç´ 
  let toast = document.querySelector('.toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.className = 'toast';
    document.body.appendChild(toast);
  }
  
  // è®¾ç½®æ¶ˆæ¯å¹¶æ˜¾ç¤º
  toast.textContent = message;
  toast.classList.add('show');
  
  // è®¾ç½®è‡ªåŠ¨éšè—
  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

// æ˜¾ç¤ºé‚®ä»¶åˆ†äº«å¯¹è¯æ¡†
function showEmailShareDialog(note) {
  // é‡ç½®è¡¨å•
  fromEmailInput.value = '';
  toEmailInput.value = '';
  emailSubjectInput.value = `åˆ†äº«ç¬”è®°ï¼š${note.title}`;
  
  // ä¿å­˜å½“å‰ç¬”è®°åˆ°å¯¹è¯æ¡†
  emailShareDialog.dataset.noteId = note.id;
  
  // æ˜¾ç¤ºå¯¹è¯æ¡†
  emailShareDialog.classList.remove('hidden');
  
  // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
  emailShareDialog.addEventListener('click', closeEmailShareDialogOnBlankClick);
}

// éšè—é‚®ä»¶åˆ†äº«å¯¹è¯æ¡†
function hideEmailShareDialog() {
  emailShareDialog.classList.add('hidden');
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  emailShareDialog.removeEventListener('click', closeEmailShareDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­é‚®ä»¶åˆ†äº«å¯¹è¯æ¡†
function closeEmailShareDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === emailShareDialog) {
    hideEmailShareDialog();
  }
}

// å‘é€é‚®ä»¶åˆ†äº«
async function sendEmailShare() {
  const noteId = emailShareDialog.dataset.noteId;
  if (!noteId) {
    showToast('æ²¡æœ‰è¦åˆ†äº«çš„ç¬”è®°');
    return;
  }
  
  const fromEmail = fromEmailInput.value.trim();
  const toEmail = toEmailInput.value.trim();
  const subject = emailSubjectInput.value.trim() || 'åˆ†äº«ç¬”è®°';
  
  if (!toEmail) {
    showToast('è¯·è¾“å…¥æ”¶ä»¶äººé‚®ç®±');
    return;
  }
  
  try {
    // è·å–ç¬”è®°å†…å®¹
    const note = await ipcRenderer.invoke('get-note', noteId);
    if (!note) {
      showToast('ç¬”è®°ä¸å­˜åœ¨');
      return;
    }
    
    // æå–çº¯æ–‡æœ¬å†…å®¹
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = note.content;
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    
    // æ„å»ºé‚®ä»¶å†…å®¹
    const emailContent = `${note.title}\n\n${textContent}\n\n(æ­¤ç¬”è®°ç”±"å°è®°äº‹"åº”ç”¨åˆ†äº«)`;
    
    // å‘é€é‚®ä»¶
    const result = await ipcRenderer.invoke('send-email', {
      fromEmail,
      toEmail,
      subject,
      content: emailContent
    });
    
    if (result.success) {
      showToast('å·²æ‰“å¼€é‚®ä»¶åº”ç”¨');
      hideEmailShareDialog();
    } else {
      showToast('å‘é€é‚®ä»¶å¤±è´¥');
    }
  } catch (error) {
    console.error('é‚®ä»¶åˆ†äº«å¤±è´¥:', error);
    showToast('é‚®ä»¶åˆ†äº«å¤±è´¥');
  }
}

// åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºåˆ†äº«
async function createTempFileForSharing(note) {
  try {
    // æå–çº¯æ–‡æœ¬å’ŒHTMLå†…å®¹
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = note.content;
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    
    const htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${escapeHtml(note.title)}</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
    h1 { color: #4a69bd; }
  </style>
</head>
<body>
  <h1>${escapeHtml(note.title)}</h1>
  <div>${note.content}</div>
</body>
</html>`;
    
    // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    const result = await ipcRenderer.invoke('create-temp-files-for-sharing', {
      title: note.title,
      textContent: `${note.title}\n\n${textContent}`,
      htmlContent: htmlContent
    });
    
    if (result.success) {
      return result.htmlPath; // è¿”å›HTMLæ–‡ä»¶è·¯å¾„ï¼Œå› ä¸ºå®ƒåŒ…å«æ ¼å¼
    } else {
      console.error('åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤±è´¥:', result.error);
      return null;
    }
  } catch (error) {
    console.error('åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤±è´¥:', error);
    return null;
  }
}

// æ·»åŠ é“¾æ¥æ˜¾ç¤ºæ–¹å¼ç›¸å…³å…ƒç´ 
const linksPositionDefaultRadio = document.getElementById('links-position-default');
const linksPositionRightRadio = document.getElementById('links-position-right');
const linksPositionBottomRadio = document.getElementById('links-position-bottom');
const linksRightTrigger = document.getElementById('links-right-trigger');

// åº”ç”¨é“¾æ¥æ˜¾ç¤ºä½ç½®
function applyLinksDisplayPosition(position) {
  if (linksDisplay) {
    // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ä½ç½®ç±»
    linksDisplay.classList.remove('right-side', 'bottom-side');
    
    // æ˜¾ç¤ºæˆ–éšè—å³ä¾§è§¦å‘å™¨
    if (linksRightTrigger) {
      linksRightTrigger.classList.add('hidden');
    }
    
    // æ·»åŠ å¯¹åº”çš„ä½ç½®ç±»å¹¶å¤„ç†DOMä½ç½®
    if (position === 'right') {
      linksDisplay.classList.add('right-side');
      if (linksRightTrigger) {
        linksRightTrigger.classList.remove('hidden');
      }
      
      // å³ä¾§æ¨¡å¼æ—¶ï¼Œç¡®ä¿åœ¨åˆ—è¡¨å®¹å™¨ä¸­
      if (linksDisplay.parentElement !== notesListContainer) {
        notesListContainer.insertBefore(linksDisplay, notesList);
      }
    } else if (position === 'bottom') {
      linksDisplay.classList.add('bottom-side');
      
      // åº•éƒ¨æ¨¡å¼æ—¶ï¼Œå°†é“¾æ¥æ˜¾ç¤ºåŒºç§»åŠ¨åˆ°bodyæœ«å°¾
      if (linksDisplay.parentElement !== document.body) {
        document.body.appendChild(linksDisplay);
      }
    } else {
      // é»˜è®¤æ¨¡å¼æ—¶ï¼Œæ”¾å›åˆ—è¡¨å®¹å™¨ä¸­
      if (linksDisplay.parentElement !== notesListContainer) {
        notesListContainer.insertBefore(linksDisplay, notesList);
      }
    }
    
    // é‡æ–°æ¸²æŸ“é“¾æ¥æ˜¾ç¤º
    renderLinksDisplay();
  }
}

// åˆ‡æ¢é“¾æ¥æ˜¾ç¤ºä½ç½®
async function toggleLinksDisplayPosition(position) {
  settings.linksDisplayPosition = position;
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    applyLinksDisplayPosition(position);
  } catch (error) {
    console.error('æ›´æ–°é“¾æ¥æ˜¾ç¤ºä½ç½®è®¾ç½®å¤±è´¥:', error);
  }
}

// æ·»åŠ æ–‡æœ¬æ–‡ä»¶æ‹–æ‹½å¤„ç†å‡½æ•°
function setupTxtFileDragDrop() {
  const dropZone = addNoteDialog;
  
  // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
  dropZone.removeEventListener('dragover', handleDialogDragOver);
  dropZone.removeEventListener('drop', handleDialogDrop);
  
  // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
  dropZone.addEventListener('dragover', handleDialogDragOver);
  dropZone.addEventListener('drop', handleDialogDrop);
}

// å¤„ç†å¯¹è¯æ¡†æ‹–æ‹½æ‚¬åœ
function handleDialogDragOver(event) {
  event.preventDefault();
  event.stopPropagation();
  event.dataTransfer.dropEffect = 'copy';
}

// å¤„ç†å¯¹è¯æ¡†æ‹–æ‹½æ”¾ç½®
async function handleDialogDrop(event) {
  event.preventDefault();
  event.stopPropagation();
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ‹–å…¥
  if (event.dataTransfer.files.length > 0) {
    const file = event.dataTransfer.files[0];
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡æœ¬æ–‡ä»¶
    if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
      try {
        // è¯»å–æ–‡æœ¬æ–‡ä»¶å†…å®¹
        const content = await readTextFile(file);
        if (!content) return;
        
        // æå–ç¬¬ä¸€è¡Œä½œä¸ºæ ‡é¢˜
        const lines = content.split('\n');
        let title = lines[0].trim();
        
        // å¦‚æœæ ‡é¢˜å¤ªé•¿ï¼Œæˆªå–ä¸€éƒ¨åˆ†
        if (title.length > 50) {
          title = title.substring(0, 47) + '...';
        }
        
        // å°†å‰©ä½™å†…å®¹ä½œä¸ºç¬”è®°æ­£æ–‡
        const noteContent = lines.slice(1).join('\n').trim();
        
        // æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
        showTargetSelectionDialog(title, noteContent);
      } catch (error) {
        console.error('è¯»å–æ–‡æœ¬æ–‡ä»¶å¤±è´¥:', error);
      }
    } else {
      showToast('åªæ”¯æŒ.txtæ–‡æœ¬æ–‡ä»¶');
    }
  }
}

// è¯»å–æ–‡æœ¬æ–‡ä»¶
function readTextFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      resolve(e.target.result);
    };
    
    reader.onerror = function(e) {
      reject(e);
    };
    
    reader.readAsText(file);
  });
}

// æ·»åŠ é€‰æ‹©ç›®æ ‡å¯¹è¯æ¡†
const targetSelectionDialog = document.createElement('div');
targetSelectionDialog.className = 'dialog target-selection-dialog hidden';
targetSelectionDialog.innerHTML = `
  <div class="dialog-content">
    <h2>é€‰æ‹©æ·»åŠ ä½ç½®</h2>
    <div class="target-list-container">
      <div id="target-list"></div>
    </div>
    <div class="new-outline-option">
      <label>
        <input type="radio" name="target-type" value="new" checked>
        åˆ›å»ºä¸ºæ–°ç¬”è®°
      </label>
    </div>
    <div class="dialog-buttons">
      <button id="target-cancel-btn" class="cancel-btn">å–æ¶ˆ</button>
      <button id="target-confirm-btn" class="confirm-btn">ç¡®å®š</button>
    </div>
  </div>
`;
document.body.appendChild(targetSelectionDialog);

// è·å–ç›®æ ‡é€‰æ‹©å¯¹è¯æ¡†å…ƒç´ 
const targetList = document.getElementById('target-list');
const targetCancelBtn = document.getElementById('target-cancel-btn');
const targetConfirmBtn = document.getElementById('target-confirm-btn');

// æ˜¾ç¤ºç›®æ ‡é€‰æ‹©å¯¹è¯æ¡†
async function showTargetSelectionDialog(title, content) {
  try {
    // éšè—æ·»åŠ å¯¹è¯æ¡†
    hideAddNoteDialog();
    
    // è·å–æ‰€æœ‰ç¬”è®°
    const notes = await ipcRenderer.invoke('get-notes');
    
    // æ¸²æŸ“ç›®æ ‡åˆ—è¡¨
    renderTargetList(notes);
    
    // å­˜å‚¨æ–‡ä»¶å†…å®¹åˆ°å¯¹è¯æ¡†æ•°æ®å±æ€§
    targetSelectionDialog.dataset.title = title;
    targetSelectionDialog.dataset.content = content;
    
    // æ˜¾ç¤ºç›®æ ‡é€‰æ‹©å¯¹è¯æ¡†
    targetSelectionDialog.classList.remove('hidden');
    
    // æ·»åŠ æŒ‰é’®äº‹ä»¶
    targetCancelBtn.onclick = hideTargetSelectionDialog;
    targetConfirmBtn.onclick = () => confirmTargetSelection(title, content);
    
    // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„åŠŸèƒ½
    targetSelectionDialog.addEventListener('click', closeTargetSelectionDialogOnBlankClick);
  } catch (error) {
    console.error('å‡†å¤‡ç›®æ ‡é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥:', error);
  }
}

// éšè—ç›®æ ‡é€‰æ‹©å¯¹è¯æ¡†
function hideTargetSelectionDialog() {
  targetSelectionDialog.classList.add('hidden');
  
  // ç§»é™¤ç‚¹å‡»ç©ºç™½å¤„å…³é—­å¯¹è¯æ¡†çš„äº‹ä»¶ç›‘å¬å™¨
  targetSelectionDialog.removeEventListener('click', closeTargetSelectionDialogOnBlankClick);
}

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­ç›®æ ‡é€‰æ‹©å¯¹è¯æ¡†
function closeTargetSelectionDialogOnBlankClick(event) {
  // åªæœ‰å½“ç‚¹å‡»çš„æ˜¯å¯¹è¯æ¡†çš„èƒŒæ™¯ï¼ˆä¸æ˜¯å¯¹è¯æ¡†å†…å®¹ï¼‰æ—¶æ‰å…³é—­
  if (event.target === targetSelectionDialog) {
    hideTargetSelectionDialog();
  }
}

// æ¸²æŸ“ç›®æ ‡åˆ—è¡¨
function renderTargetList(notes) {
  targetList.innerHTML = '';
  
  if (notes.length === 0) {
    targetList.innerHTML = '<div class="empty-state">æš‚æ— ç¬”è®°</div>';
    return;
  }
  
  // é€’å½’æ¸²æŸ“æ‰€æœ‰çº§åˆ«çš„ç¬”è®°é€‰é¡¹
  const renderNoteOption = (note, level = 0) => {
    const noteOption = document.createElement('div');
    noteOption.className = 'target-option';
    
    // æ ¹æ®çº§åˆ«æ·»åŠ ç¼©è¿›
    const indent = '&nbsp;'.repeat(level * 4);
    
    noteOption.innerHTML = `
      <label>
        <input type="radio" name="target-type" value="${note.id}">
        ${indent}${level > 0 ? 'â”” ' : ''}${escapeHtml(note.title)}
      </label>
    `;
    
    targetList.appendChild(noteOption);
    
    // é€’å½’æ¸²æŸ“å­ç¬”è®°
    if (note.children && note.children.length > 0) {
      note.children.forEach(child => {
        renderNoteOption(child, level + 1);
      });
    }
  };
  
  // æ¸²æŸ“æ‰€æœ‰ç¬”è®°
  notes.forEach(note => {
    renderNoteOption(note);
  });
}

// ç¡®è®¤ç›®æ ‡é€‰æ‹©
async function confirmTargetSelection(title, content) {
  // è·å–é€‰ä¸­çš„ç›®æ ‡ç±»å‹
  const selectedTarget = document.querySelector('input[name="target-type"]:checked');
  if (!selectedTarget) return;
  
  const targetValue = selectedTarget.value;
  
  try {
    if (targetValue === 'new') {
      // åˆ›å»ºæ–°ç¬”è®°
      const newOutline = await ipcRenderer.invoke('add-outline', title);
      // è®¾ç½®å†…å®¹
      await ipcRenderer.invoke('update-note', newOutline.id, content, Date.now());
      // åˆ·æ–°ç¬”è®°åˆ—è¡¨
      await loadNotes();
      // æ‰“å¼€æ–°ç¬”è®°
      openNote(newOutline.id);
    } else {
      // æ·»åŠ ä¸ºå­ç¬”è®°
      const newSubnote = await ipcRenderer.invoke('add-subnote', targetValue, title);
      // è®¾ç½®å†…å®¹
      await ipcRenderer.invoke('update-note', newSubnote.id, content, Date.now());
      // åˆ·æ–°ç¬”è®°åˆ—è¡¨
      await loadNotes();
      // æ‰“å¼€æ–°ç¬”è®°
      openNote(newSubnote.id);
    }
    
    // éšè—å¯¹è¯æ¡†
    hideTargetSelectionDialog();
  } catch (error) {
    console.error('æ·»åŠ ç¬”è®°å¤±è´¥:', error);
    showToast('æ·»åŠ ç¬”è®°å¤±è´¥');
  }
}

// æ·»åŠ å…¨å±€æ ·å¼
function addGlobalStyles() {
  const styleElement = document.createElement('style');
  styleElement.textContent = `
    .target-selection-dialog {
      z-index: 1001;
    }
    
    .target-list-container {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
    }
    
    .target-option, .new-outline-option {
      margin-bottom: 8px;
    }
    
    .edit-title-input {
      width: 100%;
      padding: 2px 5px;
      font-size: inherit;
      font-family: inherit;
      border: 1px solid #4a69bd;
      border-radius: 3px;
      outline: none;
    }
    
    .note-title-text {
      cursor: text;
    }
  `;
  document.head.appendChild(styleElement);
}

// ä¿®æ”¹æ·»åŠ ç¬”è®°å¯¹è¯æ¡†ï¼Œæ·»åŠ æç¤ºæ–‡æœ¬
function addDragDropTipToDialog() {
  // ä½¿ç”¨å·²å­˜åœ¨çš„addNoteDialogå˜é‡
  if (addNoteDialog) {
    // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ æç¤ºæ–‡æœ¬
    if (addNoteDialog.querySelector('.drag-tip')) {
      // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°æ–‡æœ¬å†…å®¹
      const existingTip = addNoteDialog.querySelector('.drag-tip');
      existingTip.textContent = 'æ”¯æŒtxtæ–‡æœ¬æ‹–æ‹½æ·»åŠ ã€æ”¯æŒç¬”è®°æ‹–å‡ºä¸ºtxtæ–‡æœ¬';
      return;
    }
    
    // æŸ¥æ‰¾è¾“å…¥æ 
    const titleInput = addNoteDialog.querySelector('#note-title-input');
    if (titleInput) {
      // æ·»åŠ æç¤ºæ–‡æœ¬å…ƒç´ 
      const dragTipElement = document.createElement('div');
      dragTipElement.className = 'drag-tip';
      dragTipElement.textContent = 'æ”¯æŒtxtæ–‡æœ¬æ‹–æ‹½æ·»åŠ ã€æ”¯æŒç¬”è®°æ‹–å‡ºä¸ºtxtæ–‡æœ¬';
      
      // å°†æç¤ºæ–‡æœ¬æ·»åŠ åˆ°è¾“å…¥æ åé¢
      titleInput.parentNode.insertBefore(dragTipElement, titleInput.nextSibling);
      
      // æ·»åŠ æ ·å¼
      const styleElement = document.createElement('style');
      styleElement.textContent = `
        .drag-tip {
          font-size: 12px;
          color: #666;
          text-align: left;
          margin-top: 5px;
          margin-bottom: 15px;
          font-style: italic;
          padding-left: 2px;
        }
      `;
      document.head.appendChild(styleElement);
    }
  }
}

// åœ¨DOMåŠ è½½å®Œæˆåæ·»åŠ æç¤ºæ–‡æœ¬
document.addEventListener('DOMContentLoaded', () => {
  initApp();
  addGlobalStyles();
  addDragDropTipToDialog();
});

// å¼€å§‹æ ‡é¢˜ç¼–è¾‘
function startTitleEdit(noteId, titleElement) {
  const currentTitle = titleElement.textContent;
  
  // ä¿å­˜åŸå§‹æ ‡é¢˜åˆ°dataset
  titleElement.dataset.originalTitle = currentTitle;
  
  // åˆ›å»ºè¾“å…¥æ¡†
  const titleInput = document.createElement('input');
  titleInput.type = 'text';
  titleInput.className = 'edit-title-input';
  titleInput.value = currentTitle;
  
  // æ›¿æ¢æ ‡é¢˜ä¸ºè¾“å…¥æ¡†
  titleElement.innerHTML = '';
  titleElement.appendChild(titleInput);
  
  // èšç„¦è¾“å…¥æ¡†å¹¶é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
  titleInput.focus();
  titleInput.select();
  
  // æ·»åŠ è¾“å…¥äº‹ä»¶
  titleInput.addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
      saveTitleEdit(noteId, titleInput, titleElement);
    } else if (event.key === 'Escape') {
      cancelTitleEdit(titleElement, currentTitle);
    }
  });
  
  // æ·»åŠ å¤±ç„¦äº‹ä»¶
  titleInput.addEventListener('blur', function() {
    saveTitleEdit(noteId, titleInput, titleElement);
  });
  
  // é˜»æ­¢ç‚¹å‡»è¾“å…¥æ¡†æ—¶å†’æ³¡åˆ°ç¬”è®°é¡¹
  titleInput.addEventListener('click', function(e) {
    e.stopPropagation();
  });
}

// ä¿å­˜æ ‡é¢˜ç¼–è¾‘
async function saveTitleEdit(noteId, titleInput, titleElement) {
  const newTitle = titleInput.value.trim();
  
  if (newTitle && newTitle !== titleElement.dataset.originalTitle) {
    try {
      // æ›´æ–°ç¬”è®°æ ‡é¢˜
      const result = await ipcRenderer.invoke('update-note-title', noteId, newTitle);
      
      if (result.success) {
        // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹è¯¥ç¬”è®°ï¼Œä¹Ÿæ›´æ–°æ ‡é¢˜æ˜¾ç¤º
        if (currentNoteId === noteId) {
          noteTitleDisplay.textContent = newTitle;
        }
        
        // æ¢å¤æ ‡é¢˜å…ƒç´ ï¼Œæ˜¾ç¤ºæ–°æ ‡é¢˜
        titleElement.textContent = newTitle;
        
        // åˆ·æ–°ç¬”è®°åˆ—è¡¨ä»¥ç¡®ä¿æ‰€æœ‰æ˜¾ç¤ºçš„åœ°æ–¹éƒ½æ›´æ–°
        loadNotes();
      } else {
        console.error('æ›´æ–°æ ‡é¢˜å¤±è´¥:', result.error);
        titleElement.textContent = titleElement.dataset.originalTitle || titleElement.textContent;
        showToast('æ›´æ–°æ ‡é¢˜å¤±è´¥');
      }
    } catch (error) {
      console.error('æ›´æ–°æ ‡é¢˜å¤±è´¥:', error);
      // æ¢å¤åŸæ ‡é¢˜
      titleElement.textContent = titleElement.dataset.originalTitle || titleElement.textContent;
      showToast('æ›´æ–°æ ‡é¢˜å¤±è´¥');
    }
  } else {
    // å¦‚æœæ ‡é¢˜æ²¡æœ‰å˜åŒ–æˆ–ä¸ºç©ºï¼Œæ¢å¤åŸæ ‡é¢˜
    titleElement.textContent = titleElement.dataset.originalTitle || titleElement.textContent;
  }
}

// å–æ¶ˆæ ‡é¢˜ç¼–è¾‘
function cancelTitleEdit(titleElement, originalTitle) {
  titleElement.textContent = originalTitle;
}

// æ›´æ–°æœ€å¤§å±‚çº§é¢„è§ˆ
function updateMaxLevelPreview() {
  maxLevelValue.textContent = maxLevelSlider.value;
}

// æ›´æ”¹æœ€å¤§å±‚çº§
async function changeMaxLevel() {
  settings.maxLevel = parseInt(maxLevelSlider.value);
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    updateMaxLevelPreview();
  } catch (error) {
    console.error('æ›´æ–°æœ€å¤§å±‚çº§è®¾ç½®å¤±è´¥:', error);
  }
}

// æ›´æ–°æœ€å¤§å­çº§æ•°é‡é¢„è§ˆ
function updateMaxChildrenPreview() {
  const value = parseInt(maxChildrenSlider.value);
  // å¦‚æœå€¼ä¸º0åˆ™æ˜¾ç¤º"æ— é™åˆ¶"ï¼Œå¦åˆ™æ˜¾ç¤ºæ•°å€¼
  maxChildrenValue.textContent = value === 0 ? 'æ— é™åˆ¶' : value;
}

// æ›´æ”¹æœ€å¤§å­çº§æ•°é‡
async function changeMaxChildren() {
  settings.maxChildren = parseInt(maxChildrenSlider.value);
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    updateMaxChildrenPreview();
  } catch (error) {
    console.error('æ›´æ–°æœ€å¤§å­çº§æ•°é‡è®¾ç½®å¤±è´¥:', error);
  }
}

// æ·»åŠ æ–°çš„æ— é™åˆ¶æŒ‰é’®å¤„ç†å‡½æ•°
async function setUnlimitedChildren() {
  // è®¾ç½®ä¸º0è¡¨ç¤ºæ— é™åˆ¶
  settings.maxChildren = 0;
  
  // æ›´æ–°æ»‘å—å’Œæ˜¾ç¤ºå€¼
  maxChildrenSlider.value = 0;
  maxChildrenValue.textContent = 'æ— é™åˆ¶';
  
  try {
    await ipcRenderer.invoke('update-settings', settings);
    showToast('å·²è®¾ç½®ä¸ºæ— é™åˆ¶');
  } catch (error) {
    console.error('æ›´æ–°è®¾ç½®å¤±è´¥:', error);
  }
}